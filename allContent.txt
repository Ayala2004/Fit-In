
[DIR] app

  [DIR] api

    [DIR] auth

      [DIR] login

        [FILE] route.ts
import { NextResponse } from 'next/server';
import { prisma } from '@/lib/prisma';
import { encrypt } from '@/lib/auth';
import { cookies } from 'next/headers';
import bcrypt from 'bcrypt'; // ייבוא bcrypt

export async function POST(req: Request) {
  try {
    const { email, password } = await req.json();
    
    const user = await prisma.user.findUnique({
      where: { email },
    });

    // שימוש ב-bcrypt להשוואת הסיסמה המוצפנת
    const isPasswordValid = user ? await bcrypt.compare(password, user.password) : false;

    if (!user || !isPasswordValid) {
      return NextResponse.json({ message: 'פרטים שגויים' }, { status: 401 });
    }

    // יצירת הסשן
    const expires = new Date(Date.now() + 2 * 60 * 60 * 1000);
    const session = await encrypt({ 
      id: user.id, 
      roles: user.roles, 
      name: `${user.firstName} ${user.lastName}` 
    });

    const cookieStore = await cookies();
    cookieStore.set('session', session, { 
      expires, 
      httpOnly: true, 
      secure: process.env.NODE_ENV === 'production',
      path: '/',
    });

    return NextResponse.json({
      id: user.id,
      name: `${user.firstName} ${user.lastName}`,
      roles: user.roles
    });
  } catch (error) {
    console.error(error);
    return NextResponse.json({ message: 'שגיאת שרת' }, { status: 500 });
  }
}

      [DIR] logout

        [FILE] route.ts
import { NextResponse } from 'next/server';
import { cookies } from 'next/headers';

export async function POST() {
  const cookieStore = await cookies();
  
  // מחיקת ה-Cookie על ידי הגדרת תוקף לעבר
  cookieStore.set('session', '', { expires: new Date(0), path: '/' });

  return NextResponse.json({ message: 'Logged out successfully' });
}

      [DIR] me

        [FILE] route.ts
import { NextResponse } from 'next/server';
import { cookies } from 'next/headers';
import { decrypt } from '@/lib/auth'; // הפונקציה שמשחזרת את המידע מהטוקן

export async function GET() {
  try {
    const cookieStore = await cookies();
    const session = cookieStore.get('session')?.value;

    if (!session) {
      return NextResponse.json({ message: 'לא מחובר' }, { status: 401 });
    }

    // פענוח הסשן (מכיל id, roles, name כפי שהגדרת ב-Login)
    const payload = await decrypt(session);

    if (!payload) {
      return NextResponse.json({ message: 'סשן לא תקין' }, { status: 401 });
    }

    return NextResponse.json(payload);
  } catch (error) {
    return NextResponse.json({ message: 'שגיאת שרת' }, { status: 500 });
  }
}

    [DIR] calendar

      [FILE] route.ts
import { NextResponse } from "next/server";
import { db_getCalendarData, db_quickUpdatePlacement } from "@/services/placementService";
import { prisma } from "@/lib/prisma";

export async function GET(req: Request) {
  const { searchParams } = new URL(req.url);
  const month = parseInt(searchParams.get("month") || "");
  const year = parseInt(searchParams.get("year") || "");
  const supervisorId = searchParams.get("supervisorId") || "";

  const data = await db_getCalendarData(month, year, supervisorId);
  return NextResponse.json(data);
}

export async function DELETE(req: Request) {
  const { id } = await req.json();
  await prisma.placement.delete({ where: { id } });
  return NextResponse.json({ success: true });
}

    [DIR] dashboard

      [FILE] route.ts
import { NextResponse } from 'next/server';
import { getSession } from '@/lib/auth';
import { db_getSupervisorDashboard } from '@/services/placementService';

export async function GET() {
  const session = await getSession();
  if (!session || !session.roles.includes("SUPERVISOR")) {
    return NextResponse.json({ message: "לא מורשה" }, { status: 401 });
  }

  try {
    const dashboardData = await db_getSupervisorDashboard(session.id);
    return NextResponse.json(dashboardData);
  } catch (error) {
    return NextResponse.json({ message: "שגיאת שרת" }, { status: 500 });
  }
}

    [DIR] supervisor

      [DIR] dashboard

        [FILE] route.ts
import { NextResponse } from 'next/server';
import { getSession } from '@/lib/auth';
import { db_getSupervisorDashboard } from '@/services/placementService';

export async function GET() {
  // 1. בדיקת אבטחה - האם המשתמש מחובר והוא אכן מפקחת
  const session = await getSession();
  
  if (!session || !session.roles.includes("SUPERVISOR")) {
    return NextResponse.json({ message: "גישה נדחתה: דרושה הרשאת מפקחת" }, { status: 401 });
  }

  try {
    // 2. קריאה לשירות שבונה את נתוני ה-Dashboard (הפונקציה שבנינו ב-placementService)
    const dashboardData = await db_getSupervisorDashboard(session.id);
    
    // 3. החזרת הנתונים ל-Frontend
    return NextResponse.json(dashboardData);
  } catch (error) {
    console.error("Dashboard API Error:", error);
    return NextResponse.json({ message: "שגיאת שרת פנימית בטעינת הנתונים" }, { status: 500 });
  }
}

      [DIR] institutions

        [FILE] route.ts
import { NextResponse } from 'next/server';
import { db_createInstitution } from '@/services/institutionService';
import { getSession } from '@/lib/auth';

export async function POST(req: Request) {
  try {
    const session = await getSession();
    if (!session || !session.roles.includes("SUPERVISOR")) {
      return NextResponse.json({ message: "לא מורשה" }, { status: 401 });
    }

    const body = await req.json();
    
    // הוספת ה-supervisorId מהסשן באופן אוטומטי
    const institutionData = {
      ...body,
      supervisorId: session.id,
    };

    const newInstitution = await db_createInstitution(institutionData);

    return NextResponse.json({ 
      message: 'הגן נוצר בהצלחה', 
      institution: newInstitution 
    });
  } catch (error: any) {
    console.error(error);
    if (error.code === 'P2002') {
      return NextResponse.json({ message: 'מספר מוסד זה כבר קיים במערכת' }, { status: 400 });
    }
    return NextResponse.json({ message: 'שגיאה ביצירת הגן' }, { status: 500 });
  }
}

      [DIR] instructors

        [FILE] route.ts
import { NextResponse } from 'next/server';
import { prisma } from '@/lib/prisma';
export async function GET() {
  const instructors = await prisma.user.findMany({
    where: { roles: { has: 'INSTRUCTOR' } },
    select: { id: true, firstName: true, lastName: true }
  });
  return NextResponse.json(instructors);
}

      [DIR] managers

        [FILE] route.ts
import { NextResponse } from 'next/server';
import { prisma } from '@/lib/prisma';
import { getSession } from '@/lib/auth';

export async function GET() {
  try {
    const session = await getSession();
    if (!session) return NextResponse.json({ message: "לא מורשה" }, { status: 401 });

    // 1. נשלוף את כל ה-IDs של גננות שכבר מנהלות גן
    const institutions = await prisma.institution.findMany({
      select: { mainManagerId: true }
    });
    const assignedManagerIds = institutions.map(inst => inst.mainManagerId);

    // 2. נשלוף גננות אם ששייכות למפקחת ולא נמצאות ברשימה הנ"ל
    const availableManagers = await prisma.user.findMany({
      where: {
        roles: { has: "MANAGER" },
        supervisorId: session.id,
        id: { notIn: assignedManagerIds } // סינון גננות שכבר תפוסות
      },
      select: {
        id: true,
        firstName: true,
        lastName: true,
        instructorId: true,
      }
    });

    return NextResponse.json(availableManagers);
  } catch (error) {
    return NextResponse.json({ message: "שגיאה" }, { status: 500 });
  }
}

      [DIR] placements

        [FILE] route.ts
import { NextResponse } from 'next/server';
import { prisma } from '@/lib/prisma';
import { getSession } from '@/lib/auth';
import { db_createNotification } from '@/services/notificationService';

// --- GET: מחזיר את המדריכות והשיבוצים (לצורך הטבלה והחיפוש) ---
export async function GET() {
  try {
    const session = await getSession();
    if (!session || !session.roles.includes("SUPERVISOR")) {
      return NextResponse.json({ message: "לא מורשה" }, { status: 401 });
    }

    const today = new Date();
    const startOfToday = new Date(today.setHours(0, 0, 0, 0));
    const endOfToday = new Date(today.setHours(23, 59, 59, 999));

    const instructors = await prisma.user.findMany({
      where: {
        supervisorId: session.id,
        roles: { has: "INSTRUCTOR" },
      },
      include: {
        subordinatesIns: {
          include: {
            mainManagedInstitutions: true,
            placementsAsMain: {
              where: {
                date: {
                  gte: startOfToday,
                  lte: endOfToday,
                },
              },
              include: {
                institution: true,
                substitute: true,
              }
            },
          },
        },
      },
    });

    return NextResponse.json(instructors);
  } catch (error) {
    console.error("GET Placements Error:", error);
    return NextResponse.json({ message: "שגיאת שרת" }, { status: 500 });
  }
}

// --- PATCH: עדכון שיבוץ ושליחת התראות ---
export async function PATCH(request: Request) {
  try {
    const session = await getSession();
    // הרשאה למפקחת או מדריכה
    if (!session || (!session.roles.includes("SUPERVISOR") && !session.roles.includes("INSTRUCTOR"))) {
      return NextResponse.json({ message: "לא מורשה" }, { status: 401 });
    }

    const { placementId, substituteId, status } = await request.json();

    // לוגיקה לסגירת גן (ללא מחליפה)
    if (status === "CANCELLED") {
      const updatedPlacement = await prisma.placement.update({
        where: { id: placementId },
        data: { 
          status: "CANCELLED",
          substituteId: null // מוודאים שאין מחליפה אם הגן נסגר
        }
      });
      return NextResponse.json(updatedPlacement);
    }

    // ✔ הרשאה גם למדריכה וגם למפקחת
    if (!session || (!session.roles.includes("SUPERVISOR") && !session.roles.includes("INSTRUCTOR"))) {
      return NextResponse.json({ message: "לא מורשה" }, { status: 401 });
    }

    if (!placementId) {
      return NextResponse.json({ message: "חסרים נתונים" }, { status: 400 });
    }

    // ✔ טיפול בביטול שיבוץ / סגירת גן
    if (status === "CANCELLED") {
      const cancelledPlacement = await prisma.placement.update({
        where: { id: placementId },
        data: {
          status: "CANCELLED",
          substituteId: null,
        },
        include: {
          mainTeacher: true,
          institution: true,
        },
      });

      return NextResponse.json(cancelledPlacement);
    }

    if (!substituteId) {
      return NextResponse.json({ message: "חסרים נתונים" }, { status: 400 });
    }

    const updatedPlacement = await prisma.placement.update({
      where: { id: placementId },
      data: {
        substituteId: substituteId,
        status: status || "ASSIGNED",
      },
      include: {
        mainTeacher: true,
        substitute: true,
        institution: true,
      }
    });

    if (updatedPlacement.substitute && updatedPlacement.mainTeacher) {
      const dateStr = new Date(updatedPlacement.date).toLocaleDateString('he-IL');
      const gardenName = updatedPlacement.institution.name;
      const subName = `${updatedPlacement.substitute.firstName} ${updatedPlacement.substitute.lastName}`;
      const mainName = `${updatedPlacement.mainTeacher.firstName} ${updatedPlacement.mainTeacher.lastName}`;

      await db_createNotification({
        userId: substituteId,
        title: "שיבוץ חדש עבורך",
        message: `שובצת לגן ${gardenName} בתאריך ${dateStr} במקום ${mainName}.`,
        type: "STATUS_UPDATE"
      });

      await db_createNotification({
        userId: updatedPlacement.mainTeacherId,
        title: "נמצאה מחליפה",
        message: `מעדכנים ש${subName} שובצה להחליף אותך בגן ${gardenName} בתאריך ${dateStr}.`,
        type: "STATUS_UPDATE"
      });

      if (updatedPlacement.mainTeacher.instructorId) {
        await db_createNotification({
          userId: updatedPlacement.mainTeacher.instructorId,
          title: "עדכון שיבוץ בגן",
          message: `נמצאה מחליפה (${subName}) לגן ${gardenName} עבור הגננת ${mainName} בתאריך ${dateStr}.`,
          type: "STATUS_UPDATE"
        });
      }
    }

    return NextResponse.json(updatedPlacement);
  } catch (error) {
    console.error("PATCH Error:", error);
    return NextResponse.json({ message: "שגיאה בעדכון" }, { status: 500 });
  }
}


      [DIR] register

        [FILE] route.ts
import { NextResponse } from 'next/server';
import { db_registerUser } from '@/services/authService';
import { getSession } from '@/lib/auth'; // ייבוא הסשן

export async function POST(req: Request) {
  try {
    const session = await getSession();
    if (!session) return NextResponse.json({ message: "לא מורשה" }, { status: 401 });

    const body = await req.json();
    
    const userData = {
      ...body,
      supervisorId: session.id, // הצמדת המפקחת המחוברת למשתמש החדש
    };

    const newUser = await db_registerUser(userData);
    return NextResponse.json({ message: 'המשתמש נוצר בהצלחה', user: newUser });
  } catch (error: any) {
    return NextResponse.json({ message: error.message }, { status: 400 });
  }
}

      [DIR] substitutes

        [FILE] route.ts
import { NextResponse } from 'next/server';
import { prisma } from '@/lib/prisma';
import { Day } from '@prisma/client';

export async function GET(request: Request) {
  try {
    // 1. חילוץ התאריך מה-URL
    const { searchParams } = new URL(request.url);
    const dateParam = searchParams.get('date');

    if (!dateParam) {
      return NextResponse.json({ error: "חובה לציין תאריך" }, { status: 400 });
    }

    const searchDate = new Date(dateParam);
    
    // 2. המרת התאריך ליום בשבוע (Enum של Prisma)
    const daysMap: Day[] = [
      "SUNDAY", "MONDAY", "TUESDAY", "WEDNESDAY", "THURSDAY", "FRIDAY", "SATURDAY"
    ];
    const dayOfWeek = daysMap[searchDate.getDay()];

    // הגדרת טווח התאריכים (מתחילת היום עד סופו) כדי לבדוק כפילות שיבוץ
    const startOfDay = new Date(searchDate.setHours(0, 0, 0, 0));
    const endOfDay = new Date(searchDate.setHours(23, 59, 59, 999));

    // 3. שאילתה חכמה ב-Prisma
    const substitutes = await prisma.user.findMany({
      where: {
        roles: { hasSome: ["SUBSTITUTE", "ROTATION"] },
        isWorking: true,
        // סינון 1: עובדת ביום הספציפי הזה בשבוע
        workDays: { has: dayOfWeek },
        // סינון 2: אין לה שיבוץ קיים בסטטוס ASSIGNED בתאריך הזה
        placementsAsSub: {
          none: {
            date: {
              gte: startOfDay,
              lte: endOfDay
            },
            status: "ASSIGNED"
          }
        }
      },
      select: {
        id: true,
        firstName: true,
        lastName: true,
        phoneNumber: true,
        workDays: true
      }
    });

    return NextResponse.json(substitutes);
  } catch (error) {
    console.error("Error fetching substitutes:", error);
    return NextResponse.json({ error: "שגיאת שרת" }, { status: 500 });
  }
}

    [DIR] test

      [FILE] route.ts
import { NextResponse } from "next/server";
import { db_registerUser, db_login } from "@/services/authService";
import { db_getAllUsers } from "@/services/userService";
import { db_createInstitution } from "@/services/institutionService";
import {
  db_createPlacement,
  db_assignSubstitute,
  db_updatePlacementStatus,
  db_getCalendarData,
  db_selfAssign,
} from "@/services/placementService";
import { prisma } from "@/lib/prisma";
import { Role } from "@prisma/client";

// ---------- GET ----------
export async function GET(request: Request) {
  const { searchParams } = new URL(request.url);
  const role = searchParams.get("role");
  const action = searchParams.get("action");

  try {
    let result;

    if (action === "allUsers") {
      result = await db_getAllUsers();
    } else if (role) {
      result = await prisma.user.findMany({
        where: { roles: { has: role as Role } },
      });
    } else {
      result = { message: "Please specify an action or role" };
    }

    return NextResponse.json(result);
  } catch (error: any) {
    return NextResponse.json({ error: error.message }, { status: 500 });
  }
}

// ---------- POST ----------
export async function POST(request: Request) {
  try {
    const body = await request.json();
    const { type, data } = body;

    let result;

    switch (type) {
      case "register":
        result = await db_registerUser(data);
        break;

      case "login":
        result = await db_login(data.username, data.password);
        break;

      case "institution":
        result = await db_createInstitution(data);
        break;

      case "placement":
        result = await db_createPlacement({
          ...data,
          date: new Date(data.date),
          creatorRoles: data.creatorRoles ?? [], // הגנה
        });
        break;
      case "updateStatus":
        result = await db_updatePlacementStatus({
          placementId: data.placementId,
          newStatus: data.newStatus,
          managerId: data.managerId,
        });
        break;

      case "assign":
        result = await db_assignSubstitute(data.placementId, data.substituteId);
        break;

      case "selfAssign":
        result = await db_selfAssign(data.placementId, data.substituteId);
        break;

      case "getCalendarData":
        result = await db_getCalendarData(
          data.month,
          data.year,
          data.supervisorId
        );
        break;

      default:
        return NextResponse.json({ error: "Invalid type" }, { status: 400 });
    }

    return NextResponse.json(result);
  } catch (error: any) {
    return NextResponse.json({ error: error.message }, { status: 400 });
  }
}


  [FILE] favicon.ico
         (  F          (  n  00     (-  �         �  �F  (                                                           $   ]   �   �   ]   $                                       �   �   �   �   �   �   �   �                           8   �   �   �   �   �   �   �   �   �   �   8                  �   �   �   �   �   �   �   �   �   �   �   �              �   �   �   �   �   �   �   �   �   �   �   �   �   �       #   �   �   �OOO�������������������������ggg�   �   �   �   #   Y   �   �   ��������������������������555�   �   �   �   Y   �   �   �   �   �kkk���������������������   �   �   �   �   �   �   �   �   �   �			������������������   �   �   �   �   �   Y   �   �   �   �   �JJJ���������kkk�   �   �   �   �   �   Y   #   �   �   �   �   ����������			�   �   �   �   �   �   #       �   �   �   �   �   �111�DDD�   �   �   �   �   �   �              �   �   �   �   �   �   �   �   �   �   �   �                  8   �   �   �   �   �   �   �   �   �   �   8                           �   �   �   �   �   �   �   �                                       $   ]   �   �   ]   $                                                                                                                                                                                                                                                                                    (       @                                                                               ,   U   �   �   �   �   U   ,                                                                                      *   �   �   �   �   �   �   �   �   �   �   �   �   *                                                                      �   �   �   �   �   �   �   �   �   �   �   �   �   �   �   �                                                          Q   �   �   �   �   �   �   �   �   �   �   �   �   �   �   �   �   �   �   Q                                               r   �   �   �   �   �   �   �   �   �   �   �   �   �   �   �   �   �   �   �   �   r                                       r   �   �   �   �   �   �   �   �   �   �   �   �   �   �   �   �   �   �   �   �   �   �   r                               O   �   �   �   �   �   �   �   �   �   �   �   �   �   �   �   �   �   �   �   �   �   �   �   �   O                          �   �   �   �   �   �   �   �   �   �   �   �   �   �   �   �   �   �   �   �   �   �   �   �   �   �                      �   �   �   �   �   �   �   �   �   �   �   �   �   �   �   �   �   �   �   �   �   �   �   �   �   �   �   �               (   �   �   �   �   �   �   �   �   �   �   �   �   �   �   �   �   �   �   �   �   �   �   �   �   �   �   �   �   '           �   �   �   �   �   �   �888���������������������������������������������������������___�   �   �   �   �   �   �   �          �   �   �   �   �   �   ����������������������������������������������������������SSS�   �   �   �   �   �   �   �      +   �   �   �   �   �   �   �   �hhh�����������������������������������������������������   �   �   �   �   �   �   �   �   +   T   �   �   �   �   �   �   �   ��������������������������������������������������,,,�   �   �   �   �   �   �   �   �   T   �   �   �   �   �   �   �   �   �   �GGG���������������������������������������������   �   �   �   �   �   �   �   �   �   �   �   �   �   �   �   �   �   �   �   �   ������������������������������������������   �   �   �   �   �   �   �   �   �   �   �   �   �   �   �   �   �   �   �   �   �+++���������������������������������jjj�   �   �   �   �   �   �   �   �   �   �   �   �   �   �   �   �   �   �   �   �   �   �   ����������������������������������   �   �   �   �   �   �   �   �   �   �   �   T   �   �   �   �   �   �   �   �   �   �   ��������������������������III�   �   �   �   �   �   �   �   �   �   �   �   T   +   �   �   �   �   �   �   �   �   �   �   �   �hhh����������������������   �   �   �   �   �   �   �   �   �   �   �   +      �   �   �   �   �   �   �   �   �   �   �   ������������������,,,�   �   �   �   �   �   �   �   �   �   �   �   �          �   �   �   �   �   �   �   �   �   �   �   �   �GGG�������������   �   �   �   �   �   �   �   �   �   �   �   �   �           '   �   �   �   �   �   �   �   �   �   �   �   �   ����������   �   �   �   �   �   �   �   �   �   �   �   �   (               �   �   �   �   �   �   �   �   �   �   �   �   �333�___�   �   �   �   �   �   �   �   �   �   �   �   �   �                      �   �   �   �   �   �   �   �   �   �   �   �   �   �   �   �   �   �   �   �   �   �   �   �   �   �                          O   �   �   �   �   �   �   �   �   �   �   �   �   �   �   �   �   �   �   �   �   �   �   �   �   O                               r   �   �   �   �   �   �   �   �   �   �   �   �   �   �   �   �   �   �   �   �   �   �   r                                       r   �   �   �   �   �   �   �   �   �   �   �   �   �   �   �   �   �   �   �   �   r                                               Q   �   �   �   �   �   �   �   �   �   �   �   �   �   �   �   �   �   �   Q                                                          �   �   �   �   �   �   �   �   �   �   �   �   �   �   �   �                                                                      *   �   �   �   �   �   �   �   �   �   �   �   �   *                                                                                      ,   U   �   �   �   �   U   ,                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                               (   0   `           -                                                                                             	   (   L   j   �   �   �   �   j   K   (   	                                                                                                                                          V   �   �   �   �   �   �   �   �   �   �   �   �   �   �   U                                                                                                                      %   �   �   �   �   �   �   �   �   �   �   �   �   �   �   �   �   �   �   �   �   &                                                                                                      �   �   �   �   �   �   �   �   �   �   �   �   �   �   �   �   �   �   �   �   �   �   �   �                                                                                          Q   �   �   �   �   �   �   �   �   �   �   �   �   �   �   �   �   �   �   �   �   �   �   �   �   �   �   R                                                                              �   �   �   �   �   �   �   �   �   �   �   �   �   �   �   �   �   �   �   �   �   �   �   �   �   �   �   �   �   �                                                                     �   �   �   �   �   �   �   �   �   �   �   �   �   �   �   �   �   �   �   �   �   �   �   �   �   �   �   �   �   �   �   �                                                             �   �   �   �   �   �   �   �   �   �   �   �   �   �   �   �   �   �   �   �   �   �   �   �   �   �   �   �   �   �   �   �   �   �                                                     �   �   �   �   �   �   �   �   �   �   �   �   �   �   �   �   �   �   �   �   �   �   �   �   �   �   �   �   �   �   �   �   �   �   �   �                                              �   �   �   �   �   �   �   �   �   �   �   �   �   �   �   �   �   �   �   �   �   �   �   �   �   �   �   �   �   �   �   �   �   �   �   �   �   �                                       P   �   �   �   �   �   �   �   �   �   �   �   �   �   �   �   �   �   �   �   �   �   �   �   �   �   �   �   �   �   �   �   �   �   �   �   �   �   �   O                                  �   �   �   �   �   �   �   �   �   �   �   �   �   �   �   �   �   �   �   �   �   �   �   �   �   �   �   �   �   �   �   �   �   �   �   �   �   �   �   �                              �   �   �   �   �   �   �   �   �   �   �   �   �   �   �   �   �   �   �   �   �   �   �   �   �   �   �   �   �   �   �   �   �   �   �   �   �   �   �   �   �   �                       #   �   �   �   �   �   �   �   �   �   �   �   �   �   �   �   �   �   �   �   �   �   �   �   �   �   �   �   �   �   �   �   �   �   �   �   �   �   �   �   �   �   �   #                   �   �   �   �   �   �   �   �   �   �   �   �   �   �   �   �   �   �   �   �   �   �   �   �   �   �   �   �   �   �   �   �   �   �   �   �   �   �   �   �   �   �   �   �                  �   �   �   �   �   �   �   �   �   �$$$�hhh�eee�eee�eee�eee�eee�eee�eee�eee�eee�eee�eee�eee�eee�eee�eee�eee�eee�eee�eee�eee�eee�PPP��   �   �   �   �   �   �   �   �   �              U   �   �   �   �   �   �   �   �   �   ������������������������������������������������������������������������������������������sss�   �   �   �   �   �   �   �   �   �   �   U           �   �   �   �   �   �   �   �   �   �   �   �eee��������������������������������������������������������������������������������������   �   �   �   �   �   �   �   �   �   �   �       	   �   �   �   �   �   �   �   �   �   �   �   ����������������������������������������������������������������������������������HHH�   �   �   �   �   �   �   �   �   �   �   �   �   	   (   �   �   �   �   �   �   �   �   �   �   �   �   �EEE�����������������������������������������������������������������������������   �   �   �   �   �   �   �   �   �   �   �   �   �   (   K   �   �   �   �   �   �   �   �   �   �   �   �   �   �������������������������������������������������������������������������,,,�   �   �   �   �   �   �   �   �   �   �   �   �   �   L   j   �   �   �   �   �   �   �   �   �   �   �   �   �   �)))���������������������������������������������������������������������   �   �   �   �   �   �   �   �   �   �   �   �   �   �   j   �   �   �   �   �   �   �   �   �   �   �   �   �   �   �   ������������������������������������������������������������������   �   �   �   �   �   �   �   �   �   �   �   �   �   �   �   �   �   �   �   �   �   �   �   �   �   �   �   �   �   �   ����������������������������������������������������������iii�   �   �   �   �   �   �   �   �   �   �   �   �   �   �   �   �   �   �   �   �   �   �   �   �   �   �   �   �   �   �   �   �   �eee������������������������������������������������������   �   �   �   �   �   �   �   �   �   �   �   �   �   �   �   �   �   �   �   �   �   �   �   �   �   �   �   �   �   �   �   �   ��������������������������������������������������HHH�   �   �   �   �   �   �   �   �   �   �   �   �   �   �   �   �   �   j   �   �   �   �   �   �   �   �   �   �   �   �   �   �   �   �   �EEE���������������������������������������������   �   �   �   �   �   �   �   �   �   �   �   �   �   �   �   �   �   j   L   �   �   �   �   �   �   �   �   �   �   �   �   �   �   �   �   �   �����������������������������������������,,,�   �   �   �   �   �   �   �   �   �   �   �   �   �   �   �   �   �   K   (   �   �   �   �   �   �   �   �   �   �   �   �   �   �   �   �   �   �)))�������������������������������������   �   �   �   �   �   �   �   �   �   �   �   �   �   �   �   �   �   �   (   	   �   �   �   �   �   �   �   �   �   �   �   �   �   �   �   �   �   �   ����������������������������������   �   �   �   �   �   �   �   �   �   �   �   �   �   �   �   �   �   �   	       �   �   �   �   �   �   �   �   �   �   �   �   �   �   �   �   �   �   ��������������������������iii�   �   �   �   �   �   �   �   �   �   �   �   �   �   �   �   �   �   �   �           U   �   �   �   �   �   �   �   �   �   �   �   �   �   �   �   �   �   �   �eee����������������������   �   �   �   �   �   �   �   �   �   �   �   �   �   �   �   �   �   �   U              �   �   �   �   �   �   �   �   �   �   �   �   �   �   �   �   �   �   ������������������HHH�   �   �   �   �   �   �   �   �   �   �   �   �   �   �   �   �   �   �   �                  �   �   �   �   �   �   �   �   �   �   �   �   �   �   �   �   �   �   �   �EEE�������������   �   �   �   �   �   �   �   �   �   �   �   �   �   �   �   �   �   �   �   �                   #   �   �   �   �   �   �   �   �   �   �   �   �   �   �   �   �   �   �   �   ���������,,,�   �   �   �   �   �   �   �   �   �   �   �   �   �   �   �   �   �   �   �   #                       �   �   �   �   �   �   �   �   �   �   �   �   �   �   �   �   �   �   �   �222�}}}�   �   �   �   �   �   �   �   �   �   �   �   �   �   �   �   �   �   �   �   �                              �   �   �   �   �   �   �   �   �   �   �   �   �   �   �   �   �   �   �   �   �   �   �   �   �   �   �   �   �   �   �   �   �   �   �   �   �   �   �   �                                  O   �   �   �   �   �   �   �   �   �   �   �   �   �   �   �   �   �   �   �   �   �   �   �   �   �   �   �   �   �   �   �   �   �   �   �   �   �   �   P                                       �   �   �   �   �   �   �   �   �   �   �   �   �   �   �   �   �   �   �   �   �   �   �   �   �   �   �   �   �   �   �   �   �   �   �   �   �   �                                              �   �   �   �   �   �   �   �   �   �   �   �   �   �   �   �   �   �   �   �   �   �   �   �   �   �   �   �   �   �   �   �   �   �   �   �                                                     �   �   �   �   �   �   �   �   �   �   �   �   �   �   �   �   �   �   �   �   �   �   �   �   �   �   �   �   �   �   �   �   �   �                                                             �   �   �   �   �   �   �   �   �   �   �   �   �   �   �   �   �   �   �   �   �   �   �   �   �   �   �   �   �   �   �   �                                                                     �   �   �   �   �   �   �   �   �   �   �   �   �   �   �   �   �   �   �   �   �   �   �   �   �   �   �   �   �   �                                                                              R   �   �   �   �   �   �   �   �   �   �   �   �   �   �   �   �   �   �   �   �   �   �   �   �   �   �   Q                                                                                          �   �   �   �   �   �   �   �   �   �   �   �   �   �   �   �   �   �   �   �   �   �   �   �                                                                                                      &   �   �   �   �   �   �   �   �   �   �   �   �   �   �   �   �   �   �   �   �   %                                                                                                                      U   �   �   �   �   �   �   �   �   �   �   �   �   �   �   V                                                                                                                                          	   (   K   j   �   �   �   �   j   L   (   	                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        �PNG

   IHDR         \r�f   sRGB ���   8eXIfMM *    �i            �       �           D"8s  IDATx�]	�ՙn�]<QVA���h$	�N��13*�q��d�č�I���D�L2��(�(Ԙ2�ę�G	��q_@屈���xț�Џ��{o�������U�{}�O��;������9�d���(Dg��8	��N �]��@�hx�?v �N�3�=`;�6�.�&��u��  ��6�P��н��@�àR� P�iZq�^DN���wp����X�hИHg@��
:��|�5` p"@�'�ɲ�s{�p�*�2����� d ү���|(0�
0 ��>K�
�xX�6 IJ� �C|?$KEN�}ϓ|������h $	2 ��|/� . Nz �#���W�e�
�5������ܶ���;�y �� �g�s�h^  I�� DL(�;�8��Hjg�cH|x�1��R"�a���Ӂ� G��@��9`/`%0�H�@j�~,���K
�,t).��I���D�T�O�)~��V�u$b 誛�U%�7������ _�$b 8A������J�3` 510wQ�?��vr���:�2�K�@ ��v*{%#��A�Z�咁^(��=�g \��W�����!:��,`�6��643�:@�c.Fٟ����u?�<��'������_܏vp: �8Q��
I�Ł�p{3���kHȢ�G�����c�Ѽ<�62&�
��2uC�����敭��T�3�
�����;���d�/~m��.��X�@{�w.��d]G�� {lK��Eb���(P�RuM�T�C�����d��])��_Lm�=��=@b���K��GUk�^�U�������)1����g�T���m`9�\����Q��@����Ⱆ6�:ڞ�^�w�����E�D�� �	�5����F�,��
�X"�d�m�<�nB~��@����t�t�x���;�f�>����I8����8��C1۪$B���e���+��jl��EZ��& ��S:�:�6�m����\G1��`���!�nl�l�Ɗ�^�Q`��@Oc�S��@e�ͷ���qb�p���S��@up���F�D@�Г������2@#����L3 �A��$H2� _h��FH#rq(��O�D�򤬈���runGOWa�b� &�SgD�3�ED�to�*Ǥ����9k��~)���,$� x�R�1�v�K ��9�D䍁U(�w�&LE��ꩻ�S)��3�Y8x8 $.i�(��K�ŀY����a�]����4��ǀ	c����@3�f����4� Ƣ���/*b��� ���$!I�~��7�B*-1`	o � �	�$��ǡD�����L������ �J"���OQ��)��2@#�x4�"$e ���I�8��Oi��8�"� �G��8[x�t<�.��7&�m&؎R�^��tq� ؕ�.���Y�-2� �d� ��*_��&d|j\�W�b ��G����*g�� ��釁�F4�"I�؃�/ b1q�N����Y�D��p���9���p�}w\� �Ԥ���1 j`��O���xK=��H�� �A��1�#�
D:U8j���t���$b b�A||�U�Q��26%��)1 ��_�ꢳ!~D��� ��+b >A��:]�E$��50��GDhR�t����ݻwR�)��P� ��n$� 3���@bS�Nu�,Y�j�ʲ��:����;�����@�`�|�-[)�'OV��Ն�sFxڮ��ۥ�n}͛7�����~��ƺ�:���Q��J_��UKj8�q0x���;v4 ̞=[�hW=�	��	�&�!e5�8hѢE��w�]�����6���_�iW}�SZ�?	�/`�;vl�}��2 <�h�" ����A�܁�X,�m۶�+V�(��<�w���#F�^���;���aH�c ���)S�*�{a���p��c89(�^����4�&E��oÆ��W�/��u�=�^���*?{k^�_E�����z���g�� UI-���{WU*
�:p�9.tڷo(/ݺus>��3�'�^�Rg���ڞG��I_D�������~~� ��{���?N0�7�S��.ƍ׸�~?}/y]nA;�أ���2 ]�FOB2C?�_I����[�:�:�=#�OzK�-� ��ϣ�%����?j��I���P�ۯ��{N�-hU��t�:������� ,���G�K�-hU���c�hP7 ����@�n?�\�-�k�.���2�:�� �`��F��=�-�V�_�G��܂V� ��}�0 WI����F��ʭ���sM�rZ�8pJ�Q�*@OK8���
rZ��ݖa, ��w� �S�W^y����.��5�at7��ݏ���Tv#�~7n��A"�����+��W��pM��/�hK8����g��F/^������M{e ��R�|�)q��7�t��?8'���K��P~���瞰�\��r��>�ǷUk �eP��|�^x����
�/V/��v���������*�p�v�� ����ʟ]J��}��k8(������ĉ�ѣGǗ�O�mڴq,X�o���e.�^ �Qx���p�t����4^_�N�{�����y�2 �s����� �-عsg�s���i�v��Z8
!~PJ?�c�������|�] �ܽ{��z�긓R��1pn���z�����tlp�9�f�r�v�jT殿�z�4*O�L�~����ԕ3��4�~~�r�;�m�xY�+���������3 r�;�m�x�4���:7]ՁqL�4)U��!r�1��u�6���$��7����8�w��̙3Ǹ|5�>?�\z��O���͆� ��,�E����3�����2���[����2Wu:E�����^p.H1cJ�t�]}��B�u��SOu�����Ic�O�����%�  �AZ������k����D?�5 �@Q�����3�w�+��"��T��S��Uޥ�13��?��5 M'݋��>p��Z�j�~fj�׈�סԐ�n�����>� ��i5D�[bf ��~a�'�`Xc��� -�1�k����āI�������k��Q�ů|�k�M��(92�@�t�����݂X-�Lדa��N4��qܞ'$f0@�@V�nA�ܘY�L9:�|/^s� ��	��)0`�j��T\w�uZ-����¨\�	@�:��c�t���{�-��Rb��1%� �I,Y%T���~��r�1����C��,�$��*ˀ���f<��0z����h�F���� ����|���8Z-�CR����Tg� �HRf��glY����s��-��p��'+����m�_ؒg������C�{ �	����Ȫ�ϏΙ3g�-�GR|׹7`G��񥡘�0�U��_ٵZЏ�د�D�)���\>����ʗ������z N���@��~~��-��P��{rs���@�<����|.]�Ը|��m|g����_��y�W�KD1�b�M���%�s\����r�1��n�\�ƒ�"-� �`.4��~%3��I}[0A��$��= -�>BH"G�ۏ�^r��<�EBG�i �%���9�@^�~~@�����1����@� t�-[����{%@C�$�mAg���Κ5kʆх����/双O��l��ӿ��B�@.X���u�p�O��6��x�9MPn�`߷o_���^n�`t�
��(�����\r��s�A�y���ۂ�T��@h
�E0l�0��;�tڵӘkƸN����Y�jU��
S#�|^㽺- |��p�N�.���ޥ`�^{�zL�6��4 �ě�b��e�]&"�d�sΜ9Uޥ�U0�!��*nP�*`���o֨v����i8G�����hh��m������ɓ�s�=�{J�U0�Ղ���wZ������������8bEz���,Y�D��![C�>}��7:k׮�no��f� >jvR?#b��X�(��F�AT�F��i��[�{��zv��>��C���a+�[0B2�D��=��G~�(
�ĺ������LO�\s�܂>"8|�`[)
&Lp8�'��������4 oGe�#�ۏ�lْ_\�D̀܂�2Z�l��i�9��t�ȑ9f ޢ�-����=���Y�y��n?uQ�}Xͬ�sA�i >=��1�=R��+� +�܂��.2 ��K������CƢۃ20h� �˫%53�5@�MA�%���̣������j[��9�;�� _(�����0��~r���\�{�m�P����x#TT9��n?����N#��ץ&�}� ��)
�T�VL�!���j���`�p �8@Rr�UAV�A����=��-����pLH�`@n�*Ȋ1�܂U���?}w ]�H2@�ߴi��V���[�˯%�������5 �8�)Э
T`��|rZbZ-�.�!da+@� ���ߞ�Z�gf�[0p���� �� I��gr�$��o%P�_rCy�V�|߽����"m�Y���-�[ l��k xA� ��ۯ9]�[pҤI�Ȩ�pP���k ��Feِ���gHE�d�nAm"Z�$��5}���z�8����2r�X�|� ��Sܻw��r�J�s�J�~�T�f�z{ �ͫ ��x�j?j��Q�E�n� �js���|G�xз�<dXt(��Q�E�.�p�47 ��)���;��ys�_�V�D���-XTi����?� �~�薜����� �`Q�=V�?���^�
������.]�|X�
�m�B~��?���J� �D�������~�h r�����ER���A݀�B���~w�q�Ӿ}���<�ŕ[й5�d��-�`�5 ?�Kq�~l4��0@��)����/I��(����؋���n��9���Y�4�!�Cو2ח*w9���GKݐ�s�&�r�e��s��?�6�8J� |(�uwO䴁d�&K)�nA��?R���n@7,��8�=���r�e����n�M�69k��M7�����J��R�]�e�n��9���Z���� /?នo>��󕾤�rzr�� ��`���V{���u��4448�V��ra��p� ��QRZ�<{�dK.F9��#~T���s.����N%*� ���Ýu�8G&����/W:*x%�{�}@� ��l���Nc#�AI�������i����*?�د�0}�g���C"Āpۯ������4薒ҏ(b�8�_Q�Y� ���r7'���`��� �j �6�� *��3�W�g��"��l��1�:�Sg}%� �	��P?����1`�����Y� ��"��D�0b@�� �����9������[t��F1���p`k�\U�`��R��A#W81 e`)R�ZM��� ��[u��F0�	rq.����� #^�=C"Ā9P'�R~f�� �
pn�zdC"�e���?�\K����@&$b }jz�3۵� x/{��1 Ra�#�|��ƟUK�= &�^��TM�n�2�9�5)?s���{O'�D��D���o [kM�oK0�x�� �Td�_@]b r� �G�����; ����D��D���1�gaR�`��'`0�  �>\��/���f��������ŀ����!fn�Z�|b����U�.t���ट���r�9�+��������	�b rnE�Dk�= ��8�����!b R�Cl�P�E�`�܌�K�'~�@���}*�!`�@��6 L��;��	$b@D��?#��g�F�
��V��1�v��;�Es��Q����=ɮ�4���b@T��n��!��3q�0^�V�� c ��1�ܶ��[����M�=8I����1@�څ@Cu��`N�o�� WJĀ� W����e��I�� n��N�mீ��ܴ�_d��(�4`E܅I� ���"̵�1 *3�+\�E� �\M���)g	r���
���8�>��p�?vI� �0�ǀ~�!b������$'�%"I����R��i�1 �0��? S~&�� �r�����{ n�_�����L�?��T�e��Ǝ�7�C"r��OQ~"qI� ��O 8�?$b �܋r�#@�_�v�J̙��/��3�'d�/����W[����o'N��l��-2� ���@j�O~��0���2` H�@�؄��+����pOB� �uO��(l�S�ԕ���9����~�c�:x/�Xd�.���Ɣ�d ��V�y@F $H2� ����+M*�i��l8O@F $H2� ���2�4& r�PO��֢����7N�YS ����Y�1`��;�JS3n� g[�'��@W@"la`32�n?'�HB2p
�hām�mu �����j@F@��V����Z!��xI���H�y�ѱ)��>��Z!6 ���a�`�����dDV$9f���	pM�6�I�!LG:\LdrwPy�~�P�%��L3��7�TK��Am�mo|�6��	3��-�h J3��?�67 �yr���"����g��4. $�1���_�[*��&���S/�dq�������C��h �3��>�6Ŷ%������\�#�RZq��=lK|ŔX��X�WS�e j5 /����$���:��v@������8���d��1(�z2~F�)���3��͋���l��C�������#����=�.\Lt? %� N$9b�%�:���2��u	 �1|-�	ld�����t $b��@?���@� �F�c��ρ^�D�d�[9�ࠐz�����:
H�@ ��P2v )~���@����z5��|����R�ֵ���|`#�W39؂��<�"-�0��\<�d��u�oGLz 1��Gp����e�倯d� .�jH�@j�F�3��@ c{s<��J&	�@�����b���w��  �� ��n���v��< �����,M;��*p>p!0hH��{=�����x�]I�� DLh����<'��h8�@V �#��J���f� I�� �Hn����W�}�N�t[u�$�������� �@� 2 	�]&)�� #�3���,	=%�T���k�&�  I�����I��ӳ� �[8	�	�L�]�]t�T�g���6�-@b2 U�OV��: A?��} .i�|	�xC���rv�w; ��#�>�i 8_b82 �WP����� �� {'n���8�z;�Ƥy��s� ��@���P��o|�S�ih $3��@߹j��    IEND�B`�

  [FILE] globals.css
@import "tailwindcss";

:root {
  --background: #ffffff;
  --foreground: #171717;
}

@theme inline {
  --color-background: var(--background);
  --color-foreground: var(--foreground);
  --font-sans: var(--font-geist-sans);
  --font-mono: var(--font-geist-mono);
}

@media (prefers-color-scheme: dark) {
  :root {
    --background: #0a0a0a;
    --foreground: #ededed;
  }
}

body {
  background: var(--background);
  color: var(--foreground);
  font-family: Arial, Helvetica, sans-serif;
}

:root {
  --bg-primary: #ffffff;
  --text-primary: #1a1a1a;
  --card-bg: #f9f9f9;
  --border-color: #e5e7eb;
}

@media (prefers-color-scheme: dark) {
  :root {
    --bg-primary: #121212;
    --text-primary: #ffffff;
    --card-bg: #1e1e1e;
    --border-color: #333333;
  }
}

.custom-scrollbar::-webkit-scrollbar {
  width: 5px;
}
.custom-scrollbar::-webkit-scrollbar-track {
  background: #f1f1f1;
}
.custom-scrollbar::-webkit-scrollbar-thumb {
  background: #cbd5e1;
  border-radius: 10px;
}

.placeholder-black::placeholder {
  color: #000000;
  opacity: 1;
}



  [FILE] layout.tsx
import type { Metadata } from "next";
import { Geist, Geist_Mono } from "next/font/google";
import "./globals.css";

const geistSans = Geist({
  variable: "--font-geist-sans",
  subsets: ["latin"],
});

const geistMono = Geist_Mono({
  variable: "--font-geist-mono",
  subsets: ["latin"],
});

export const metadata: Metadata = {
  title: "Create Next App",
  description: "Generated by create next app",
};

export default function RootLayout({
  children,
}: Readonly<{
  children: React.ReactNode;
}>) {
  return (
    <html lang="en">
      <body
        className={`${geistSans.variable} ${geistMono.variable} antialiased`}
        suppressHydrationWarning={true}
      >
        {children}
      </body>
    </html>
  );
}


  [DIR] login

    [FILE] login.module.css
.authContainer {
  display: flex;
  align-items: center;
  justify-content: center;
  min-height: 100vh;
  background-color: var(--bg-primary);
  direction: rtl;
}

.loginCard {
  background: var(--card-bg);
  padding: 2.5rem;
  border-radius: 1rem;
  box-shadow: 0 10px 25px rgba(0, 0, 0, 0.05);
  border: 1px solid var(--border-color);
  width: 100%;
  max-width: 400px;
}

.header {
  text-align: center;
  margin-bottom: 2rem;
}

.header h1 {
  font-size: 1.5rem;
  font-weight: 800;
  color: var(--text-primary);
}

.formGroup {
  margin-bottom: 1.25rem;
}

.label {
  display: block;
  margin-bottom: 0.5rem;
  font-size: 0.875rem;
  font-weight: 600;
}

.input {
  width: 100%;
  padding: 0.75rem;
  border-radius: 0.5rem;
  border: 1px solid var(--border-color);
  background: var(--bg-primary);
  color: var(--text-primary);
  transition: border-color 0.2s;
}

.input:focus {
  outline: none;
  border-color: var(--primary-blue);
  box-shadow: 0 0 0 2px rgba(37, 99, 235, 0.1);
}

.submitBtn {
  width: 100%;
  padding: 0.75rem;
  background: var(--primary-blue);
  color: white;
  border: none;
  border-radius: 0.5rem;
  font-weight: 700;
  cursor: pointer;
  transition: opacity 0.2s;
}

.submitBtn:disabled {
  opacity: 0.6;
  cursor: not-allowed;
}

.errorMsg {
  background: #fef2f2;
  color: #dc2626;
  padding: 0.75rem;
  border-radius: 0.4rem;
  font-size: 0.875rem;
  margin-bottom: 1rem;
  text-align: center;
}

    [FILE] page.tsx
'use client';

import { useState } from 'react';
import { useRouter } from 'next/navigation';

export default function LoginPage() {
  const [email, setEmail] = useState('');
  const [password, setPassword] = useState('');
  const [error, setError] = useState('');
  const [loading, setLoading] = useState(false);
  const router = useRouter();

  const handleSubmit = async (e: React.FormEvent) => {
    e.preventDefault();
    setLoading(true);
    setError('');

    try {
      const res = await fetch('/api/auth/login', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ email, password }),
      });

      if (res.ok) {
        const user = await res.json();
        
        // בדיקה אם הוא supervisor - אם כן, שלח אותו לדף הפלייסמנטס
        if (user.roles.includes('SUPERVISOR')) {
          router.push('/supervisor/placements');
        } else {
          router.push('/'); // או דף אחר למשתמשים רגילים
        }
        router.refresh(); // מרענן את ה-middleware כדי שיזהה את ה-cookie החדש
      } else {
        const data = await res.json();
        setError(data.message || 'משהו השתבש');
      }
    } catch (err) {
      setError('שגיאת תקשורת עם השרת');
    } finally {
      setLoading(false);
    }
  };

  return (
    <div className="flex min-h-screen items-center justify-center bg-gray-50">
      <div className="w-full max-w-md p-8 space-y-6 bg-white rounded-xl shadow-lg">
        <h1 className="text-2xl font-bold text-center text-gray-900">כניסת מפקחים</h1>
        
        <form onSubmit={handleSubmit} className="space-y-4">
          <div>
            <label className="block text-sm font-medium text-gray-700">אימייל</label>
            <input
              type="email"
              required
              className="w-full px-4 py-2 mt-1 border rounded-md focus:ring-blue-500 focus:border-blue-500 text-right"
              dir="ltr"
              value={email}
              onChange={(e) => setEmail(e.target.value)}
            />
          </div>
          
          <div>
            <label className="block text-sm font-medium text-gray-700">סיסמה</label>
            <input
              type="password"
              required
              className="w-full px-4 py-2 mt-1 border rounded-md focus:ring-blue-500 focus:border-blue-500 text-right"
              dir="ltr"
              value={password}
              onChange={(e) => setPassword(e.target.value)}
            />
          </div>

          {error && <p className="text-sm text-red-600 text-center">{error}</p>}

          <button
            type="submit"
            disabled={loading}
            className="w-full px-4 py-2 text-white bg-blue-600 rounded-md hover:bg-blue-700 disabled:bg-blue-300 transition-colors"
          >
            {loading ? 'מתחבר...' : 'התחבר'}
          </button>
        </form>
      </div>
    </div>
  );
}

  [FILE] page.tsx
import Image from "next/image";

export default function Home() {
  return (
    <div className="flex min-h-screen items-center justify-center bg-zinc-50 font-sans dark:bg-black">
      <main className="flex min-h-screen w-full max-w-3xl flex-col items-center justify-between py-32 px-16 bg-white dark:bg-black sm:items-start">
        <Image
          className="dark:invert"
          src="/next.svg"
          alt="Next.js logo"
          width={100}
          height={20}
          priority
        />
        <div className="flex flex-col items-center gap-6 text-center sm:items-start sm:text-left">
          <h1 className="max-w-xs text-3xl font-semibold leading-10 tracking-tight text-black dark:text-zinc-50">
            To get started, edit the page.tsx file.
          </h1>
          <p className="max-w-md text-lg leading-8 text-zinc-600 dark:text-zinc-400">
            Looking for a starting point or more instructions? Head over to{" "}
            <a
              href="https://vercel.com/templates?framework=next.js&utm_source=create-next-app&utm_medium=appdir-template-tw&utm_campaign=create-next-app"
              className="font-medium text-zinc-950 dark:text-zinc-50"
            >
              Templates
            </a>{" "}
            or the{" "}
            <a
              href="https://nextjs.org/learn?utm_source=create-next-app&utm_medium=appdir-template-tw&utm_campaign=create-next-app"
              className="font-medium text-zinc-950 dark:text-zinc-50"
            >
              Learning
            </a>{" "}
            center.
          </p>
        </div>
        <div className="flex flex-col gap-4 text-base font-medium sm:flex-row">
          <a
            className="flex h-12 w-full items-center justify-center gap-2 rounded-full bg-foreground px-5 text-background transition-colors hover:bg-[#383838] dark:hover:bg-[#ccc] md:w-[158px]"
            href="https://vercel.com/new?utm_source=create-next-app&utm_medium=appdir-template-tw&utm_campaign=create-next-app"
            target="_blank"
            rel="noopener noreferrer"
          >
            <Image
              className="dark:invert"
              src="/vercel.svg"
              alt="Vercel logomark"
              width={16}
              height={16}
            />
            Deploy Now
          </a>
          <a
            className="flex h-12 w-full items-center justify-center rounded-full border border-solid border-black/[.08] px-5 transition-colors hover:border-transparent hover:bg-black/[.04] dark:border-white/[.145] dark:hover:bg-[#1a1a1a] md:w-[158px]"
            href="https://nextjs.org/docs?utm_source=create-next-app&utm_medium=appdir-template-tw&utm_campaign=create-next-app"
            target="_blank"
            rel="noopener noreferrer"
          >
            Documentation
          </a>
        </div>
      </main>
    </div>
  );
}


  [DIR] report-absence

    [FILE] actions.ts
'use server'

import { prisma } from '@/lib/prisma';
import { getSession } from '@/lib/auth';
import { revalidatePath } from 'next/cache';

export async function reportAbsenceAction(prevState: any, formData: FormData) {
  const session = await getSession();
  
  if (!session) {
    return { error: 'צריך להתחבר כדי לדווח' };
  }

  const date = formData.get('date') as string;
  const reason = formData.get('reason') as string;

  try {
    // כאן תכניסי את הלוגיקה של שמירה ב-DB עם פריזמה
    // למשל:
    // await prisma.absence.create({ data: { userId: session.id, date, reason } });

    revalidatePath('/report-absence');
    return { success: true, message: 'הדיווח נשלח בהצלחה' };
  } catch (e) {
    return { error: 'שגיאה בשמירת הנתונים' };
  }
}

    [FILE] page.tsx
"use client"; // חייב להיות כאן כי אנחנו משתמשים ב-Hook

import { useActionState } from 'react';
import { reportAbsenceAction } from './actions';
export default function ReportAbsencePage() {
  // state יכיל את מה שהפונקציה בשרת מחזירה (success, message)
  // formAction הוא מה שנשים בתוך ה-form
  const [state, formAction, isPending] = useActionState(reportAbsenceAction, null);

  return (
    <div className="max-w-md mx-auto mt-10 p-6 bg-white rounded-lg shadow-md" dir="rtl">
      <h1 className="text-2xl font-bold mb-6 text-center">דיווח על היעדרות</h1>
      
      <form action={formAction} className="space-y-4">
        <div>
          <label className="block text-sm font-medium">תאריך היעדרות:</label>
          <input type="date" name="date" required className="w-full p-2 border rounded" />
        </div>

        <div>
          <label className="block text-sm font-medium">קוד מוסד (ID):</label>
          <input type="text" name="institutionId" required className="w-full p-2 border rounded" />
        </div>

        <div>
          <label className="block text-sm font-medium">תעודת זהות גננת (ID):</label>
          <input type="text" name="mainTeacherId" required className="w-full p-2 border rounded" />
        </div>

        <div>
          <label className="block text-sm font-medium">הערות:</label>
          <textarea name="notes" className="w-full p-2 border rounded" rows={3}></textarea>
        </div>

        {/* הצגת הודעת שגיאה או הצלחה */}
        {state?.message && (
          <p className={`text-sm ${state.success ? "text-green-600" : "text-red-600"}`}>
            {state.message}
          </p>
        )}

        <button 
          type="submit" 
          disabled={isPending}
          className="w-full bg-blue-600 text-white py-2 rounded hover:bg-blue-700 transition disabled:bg-gray-400"
        >
          {isPending ? "שולח..." : "שליחת דיווח"}
        </button>
      </form>
    </div>
  );
}

  [DIR] supervisor

    [DIR] calendar

      [FILE] page.tsx
"use client";
import { useState, useEffect, useCallback } from "react";
import {
  format,
  startOfMonth,
  endOfMonth,
  eachDayOfInterval,
  addMonths,
  subMonths,
  isSameDay,
} from "date-fns";
import { he } from "date-fns/locale";
import {
  Calendar as CalendarIcon,
  ChevronRight,
  ChevronLeft,
  X,
  Loader2,
  AlertCircle,
  User,
} from "lucide-react";

export default function SupervisorCalendar() {
  const [currentDate, setCurrentDate] = useState(new Date());
  const [placements, setPlacements] = useState([]);
  const [loading, setLoading] = useState(true);
  const [user, setUser] = useState<any>(null);
  const [allSubstitutes, setAllSubstitutes] = useState([]);
  const [editingPlacement, setEditingPlacement] = useState<any>(null);
  const [searchQuery, setSearchQuery] = useState("");

  // סינון המחליפות לפי חיפוש
  const filteredSubstitutes = allSubstitutes.filter((sub: any) => {
    const fullName = `${sub.firstName} ${sub.lastName}`.toLowerCase();
    return fullName.includes(searchQuery.toLowerCase());
  });
  // 1. טעינת נתונים ראשונית (משתמש ומחליפות)
  useEffect(() => {
    const initPage = async () => {
      try {
        // טעינת פרטי המשתמש המחובר מה-API החדש שיצרנו
        const userRes = await fetch("/api/auth/me");
        if (userRes.ok) {
          const userData = await userRes.json();
          setUser(userData);
        }

        // טעינת מחליפות דרך ה-GET הקיים ב-test route
        const subsRes = await fetch("/api/test?role=SUBSTITUTE");
        if (subsRes.ok) {
          const subsData = await subsRes.json();
          setAllSubstitutes(subsData);
        }
      } catch (err) {
        console.error("Initialization error:", err);
      }
    };
    initPage();
  }, []);

  // 2. שליפת נתוני השיבוצים - שימוש ב-POST כפי שמוגדר ב-test route
  const fetchData = useCallback(async () => {
    if (!user?.id) return;

    setLoading(true);
    try {
      const res = await fetch("/api/test", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({
          type: "getCalendarData",
          data: {
            month: currentDate.getMonth() + 1,
            year: currentDate.getFullYear(),
            supervisorId: user.id,
          },
        }),
      });

      const data = await res.json();
      // בדיקה אם הנתונים הם מערך לפני שמירה ב-state
      setPlacements(data);
    } catch (err) {
      console.error("Fetch error:", err);
      setPlacements([]);
    } finally {
      setLoading(false);
    }
  }, [currentDate, user]);

  useEffect(() => {
    fetchData();
  }, [fetchData]);

  // פונקציית מחיקה (צריך לוודא שיש לך DELETE ב-api/calendar או להשתמש ב-test POST)
  const handleDelete = async (id: string) => {
    if (!confirm("למחוק את הדיווח לצמיתות?")) return;
    try {
      const res = await fetch(`/api/calendar`, {
        method: "DELETE",
        body: JSON.stringify({ id }),
      });
      if (res.ok) setPlacements((prev) => prev.filter((p: any) => p.id !== id));
    } catch (err) {
      alert("שגיאה במחיקה");
    }
  };

  // פונקציית עדכון מהמודאל
  const handleQuickUpdate = async (val: string) => {
    if (!editingPlacement) return;

    try {
      // שימוש ב-assign או updateStatus בהתאם לבחירה
      const type =
        val === "CANCEL" || val === "OPEN" ? "updateStatus" : "assign";
      const bodyData =
        type === "assign"
          ? { placementId: editingPlacement.id, substituteId: val }
          : {
              placementId: editingPlacement.id,
              newStatus: val === "CANCEL" ? "CANCELLED" : "OPEN",
              managerId: user.id,
            };

      const res = await fetch("/api/test", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ type, data: bodyData }),
      });

      if (res.ok) {
        setEditingPlacement(null);
        fetchData();
      }
    } catch (err) {
      alert("שגיאה בעדכון");
    }
  };

  // חישוב ימי הלוח
  const firstDayOfMonth = startOfMonth(currentDate);
  const startWeekDay = firstDayOfMonth.getDay();
  const realDays = eachDayOfInterval({
    start: startOfMonth(currentDate),
    end: endOfMonth(currentDate),
  });
  const paddingDays = Array.from({ length: startWeekDay }, () => null);
  const days = [...paddingDays, ...realDays];

  if (!user && loading) {
    return (
      <div className="flex h-screen items-center justify-center bg-slate-50">
        <Loader2 className="animate-spin text-blue-600" size={48} />
      </div>
    );
  }

  return (
    <div className="p-8 bg-slate-50 min-h-screen font-sans" dir="rtl">
      <div className="max-w-7xl mx-auto">
        {/* כותרת וניווט חודשים */}
        <div className="flex justify-between items-center mb-8 bg-white p-6 rounded-2xl shadow-sm border border-slate-100">
          <div className="flex items-center gap-4">
            <div className="bg-blue-600 p-3 rounded-xl text-white shadow-lg shadow-blue-200">
              <CalendarIcon size={24} />
            </div>
            <div>
              <h1 className="text-2xl font-bold text-slate-800">
                יומן שיבוצים חודשי
              </h1>
              <p className="text-slate-400 text-sm">המפקחת: {user?.name}</p>
            </div>
          </div>

          <div className="flex items-center gap-6 bg-slate-100 p-2 rounded-2xl border border-slate-200">
            <button
              onClick={() => setCurrentDate(subMonths(currentDate, 1))}
              className="p-2 hover:bg-white rounded-xl shadow-sm transition-all"
            >
              <ChevronRight />
            </button>
            <span className="text-xl font-bold text-slate-700 min-w-35 text-center">
              {format(currentDate, "MMMM yyyy", { locale: he })}
            </span>
            <button
              onClick={() => setCurrentDate(addMonths(currentDate, 1))}
              className="p-2 hover:bg-white rounded-xl shadow-sm transition-all"
            >
              <ChevronLeft />
            </button>
          </div>
        </div>

        {/* הלוח */}
        <div className="bg-white rounded-4xl shadow-xl border border-slate-200 overflow-hidden">
          <div className="grid grid-cols-7 bg-slate-50/50 border-b border-slate-200">
            {["ראשון", "שני", "שלישי", "רביעי", "חמישי", "שישי", "שבת"].map(
              (d) => (
                <div
                  key={d}
                  className="p-4 text-center font-bold text-slate-400 text-xs uppercase tracking-widest"
                >
                  {d}
                </div>
              )
            )}
          </div>

          <div className="grid grid-cols-7">
            {days.map((day, index) => {
              if (!day) {
                return (
                  <div
                    key={`empty-${index}`}
                    className="min-h-37 border-l border-b border-slate-50"
                  />
                );
              }

              const isSaturday = day.getDay() === 6;
              const dayPlacements = Array.isArray(placements)
                ? placements.filter((p: any) =>
                    isSameDay(new Date(p.date), day)
                  )
                : [];

              return (
                <div
                  key={day.toString()}
                  className={`min-h-37 border-l border-b border-slate-100 p-3 transition-all ${
                    isSaturday ? "bg-slate-50/50" : "hover:bg-blue-50/20"
                  }`}
                >
                  <div className="flex justify-between items-start mb-2">
                    <span
                      className={`text-sm font-black ${
                        isSameDay(day, new Date())
                          ? "bg-blue-600 text-white w-6 h-6 flex items-center justify-center rounded-full"
                          : "text-slate-300"
                      }`}
                    >
                      {format(day, "d")}
                    </span>
                  </div>

                  {isSaturday ? (
                    <div className="mt-8 text-center text-[10px] font-bold text-slate-300 uppercase tracking-tighter">
                      יום מנוחה
                    </div>
                  ) : (
                    <div className="mt-2 space-y-2">
                      {dayPlacements.map((p: any) => (
                        <div
                          key={p.id}
                          className="group relative p-2 rounded-xl border border-slate-100 bg-white shadow-sm hover:border-blue-300 hover:shadow-md transition-all cursor-pointer"
                          onClick={() => setEditingPlacement(p)}
                        >
                          <div className="text-[16px] font-bold text-slate-700 leading-tight">
                            {p.mainTeacher?.firstName} {p.mainTeacher?.lastName}
                          </div>
                          <div
                            className={`text-[15px] mt-1 flex items-center gap-1 ${
                              p.status === "OPEN"
                                ? "text-yellow-500 font-bold"
                                : p.status === "CANCELLED"
                                ? "text-red-500 font-bold"
                                : "text-emerald-500 font-medium"
                            }`}
                          >
                            <div
                              className={`w-1 h-1 rounded-full ${
                                p.status === "OPEN"
                                  ? "bg-yellow-500 "
                                  : p.status === "CANCELLED"
                                  ? "bg-red-500 "
                                  : "bg-emerald-500 "
                              }`}
                            />
                            {p.status === "OPEN"
                              ? "ממתין"
                              : p.status === "CANCELLED"
                              ? "הגן נסגר"
                              : `${p.substitute.firstName} ${p.substitute.lastName}`}
                          </div>

                          <button
                            onClick={(e) => {
                              e.stopPropagation();
                              handleDelete(p.id);
                            }}
                            className="absolute -top-1 -left-1 opacity-0 group-hover:opacity-100 bg-red-500 text-white p-1 rounded-full shadow-lg transition-opacity hover:bg-red-600"
                          >
                            <X size={8} />
                          </button>
                        </div>
                      ))}
                    </div>
                  )}
                </div>
              );
            })}
          </div>
        </div>
      </div>

      {/* מודאל עריכה */}
      {editingPlacement && (
        <div className="fixed inset-0 bg-black/40 backdrop-blur-sm flex items-center justify-center z-50 p-4">
          <div className="bg-white rounded-lg shadow-xl w-full max-w-md overflow-hidden">
            <div className="p-5 border-b border-gray-200 flex justify-between items-center">
              <div>
                <h3 className="text-lg font-semibold text-gray-900">
                  עריכת שיבוץ
                </h3>
                <p className="text-sm text-gray-500 mt-0.5">
                  {format(new Date(editingPlacement.date), "dd/MM/yyyy")}
                </p>
              </div>
              <button
                onClick={() => setEditingPlacement(null)}
                className="p-2 hover:bg-gray-100 rounded-lg transition-colors"
              >
                <X size={20} className="text-gray-500" />
              </button>
            </div>
            <div className="p-6">
              <div>
                <label className="block text-sm font-medium text-gray-700 mb-3">
                  בחירת מחליפה או פעולה
                </label>

                {/* כפתורי פעולה מהירה */}
                <div className="grid grid-cols-2 gap-3 mb-4">
                  <button
                    onClick={() => handleQuickUpdate("CANCEL")}
                    className="p-4 rounded-lg border-2 border-gray-200 hover:border-red-500 hover:bg-red-50 transition-all text-right group"
                  >
                    <div className="flex items-center gap-3">
                      <div className=" p-2 rounded-full bg-red-100 group-hover:bg-red-200 flex items-center justify-center transition-colors">
                        <X size={20} className="text-red-600 " />
                      </div>
                      <div>
                        <div className="text-sm font-medium text-gray-900">
                          סגירת הגן
                        </div>
                        <div className="text-xs text-gray-500">ביטול יום</div>
                      </div>
                    </div>
                  </button>

                  <button
                    onClick={() => handleQuickUpdate("OPEN")}
                    className="p-4 rounded-lg border-2 border-gray-200 hover:border-orange-500 hover:bg-orange-50 transition-all text-right group"
                  >
                    <div className="flex items-center gap-3">
                      <div className="p-2 rounded-full bg-orange-100 group-hover:bg-orange-200 flex items-center justify-center transition-colors">
                        <AlertCircle size={20} className="text-orange-600 " />
                      </div>
                      <div>
                        <div className="text-sm font-medium text-gray-900">
                          מחיקת שיבוץ
                        </div>
                        <div className="text-xs text-gray-500">
                          פתחי את האפשרות לשיבוץ מחדש
                        </div>
                      </div>
                    </div>
                  </button>
                </div>

                {/* חיפוש וברירת מחליפה */}
                <div className="space-y-3">
                  <div className="relative">
                    <input
                      type="text"
                      placeholder="חיפוש גננת מחליפה..."
                      value={searchQuery}
                      onChange={(e) => setSearchQuery(e.target.value)}
                      className="w-full p-3 pr-10 rounded-lg border border-gray-300 focus:outline-none focus:ring-2 focus:ring-gray-900 focus:border-transparent text-sm placeholder-black"
                    />
                    <User
                      size={18}
                      className="absolute right-3 top-1/2 -translate-y-1/2 text-gray-400"
                    />
                  </div>

                  <div className="max-h-64 overflow-y-auto border border-gray-200 rounded-lg">
                    {filteredSubstitutes.length > 0 ? (
                      filteredSubstitutes.map((sub: any) => (
                        <button
                          key={sub.id}
                          onClick={() => handleQuickUpdate(sub.id)}
                          className="w-full p-3 hover:bg-gray-50 transition-colors border-b border-gray-100 last:border-b-0 text-right flex items-center gap-3 group"
                        >
                          <div className="w-10 h-10 rounded-full bg-gray-100 group-hover:bg-gray-200 flex items-center justify-center transition-colors shrink-0">
                            <User size={18} className="text-gray-600" />
                          </div>
                          <div className="flex-1">
                            <div className="text-sm font-medium text-gray-900">
                              {sub.firstName} {sub.lastName}
                            </div>
                          </div>
                        </button>
                      ))
                    ) : (
                      <div className="p-6 text-center text-gray-500 text-sm">
                        לא נמצאו גננות מחליפות
                      </div>
                    )}
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
      )}
    </div>
  );
}


    [DIR] dashboard

      [FILE] route.ts


    [FILE] layout.tsx
'use client';

import Navbar from '@/components/Navbar';

export default function SupervisorLayout({
  children,
}: {
  children: React.ReactNode;
}) {
  return (
    <div className="min-h-screen bg-slate-50" dir="rtl">
      {/* ה-Navbar החדש שכולל את כל הניווט */}
      <Navbar />

      {/* תוכן הדף */}
      <main className="max-w-7xl mx-auto py-8 px-4 sm:px-6 lg:px-8">
        {children}
      </main>
    </div>
  );
}

    [FILE] page.tsx
"use client";

import { useEffect, useState } from "react";
import { format, addDays, isSameDay } from "date-fns";
import { he } from "date-fns/locale";
import { AlertCircle, Clock } from "lucide-react";
import PlacementModal from "@/components/PlacementModal";

export default function SupervisorDashboardPage() {
  const [dashboardData, setDashboardData] = useState<any>(null);
  const [loading, setLoading] = useState(true);
  const [isModalOpen, setIsModalOpen] = useState(false);
  const [selectedPlacement, setSelectedPlacement] = useState<any>(null);

  const loadData = async () => {
    try {
      const res = await fetch("/api/supervisor/dashboard");
      const data = await res.json();
      setDashboardData(data);
      setLoading(false);
    } catch (e) {
      console.error(e);
    }
  };

  useEffect(() => {
    loadData();
  }, []);

  // הפונקציה לסגירת הגן
  const handleCloseGarden = async (placementId: string) => {
    if (!confirm("האם לסגור את הגן להיום עקב חוסר במחליפה?")) return;

    try {
      const res = await fetch("/api/supervisor/placements", {
        method: "PATCH",
        body: JSON.stringify({ placementId, status: "CANCELLED" }),
        headers: { "Content-Type": "application/json" },
      });

      if (res.ok) {
        loadData(); // רענון הנתונים בלוח הבקרה
      } else {
        alert("שגיאה בסגירת הגן");
      }
    } catch (e) {
      console.error(e);
    }
  };

  if (loading)
    return (
      <div className="flex items-center justify-center min-h-screen font-bold text-black">
        טוען...
      </div>
    );

    
const buildSixDisplayDays = (start: Date) => {
  const days: Date[] = [];
  let d = new Date(start);

  while (days.length < 6) {
    if (d.getDay() !== 6) {
      days.push(new Date(d));
    }
    d = addDays(d, 1);
  }

  return days;
};

const displayDaysWithoutSaturday = buildSixDisplayDays(new Date());

  const displayDays = Array.from({ length: 6 }).map((_, i) =>
    addDays(new Date(), i)
  );




  return (
    <div
      className="p-4 md:p-8 bg-[#F8FAFC] min-h-screen text-slate-800"
      dir="rtl"
    >
      <header className="mb-10">
        <h1 className="text-3xl font-extrabold text-black">
          לוח בקרה למפקחת 👋
        </h1>
      </header>

      {/* וידג'טים שבועיים */}
      <section className="mb-12">
  <div className="grid grid-cols-2 lg:grid-cols-6 gap-4 text-black">
    {displayDaysWithoutSaturday.map((date) => {
      const statsForDay = dashboardData.weeklyPlacements.filter((p: any) =>
        isSameDay(new Date(p.date), date)
      );

      const open = statsForDay.filter((p: any) => p.status === "OPEN").length;

      return (
        <div
          key={date.toString()}
          className="p-4 rounded-xl border bg-white border-slate-100 shadow-sm"
        >
          <p className="text-slate-400 text-xs">
            {format(date, "EEEE", { locale: he })}
          </p>
          <p className="font-bold">{format(date, "dd/MM")}</p>
          <div
            className={`mt-2 text-xs font-bold ${
              open > 0 ? "text-red-600" : "text-emerald-600"
            }`}
          >
            {open > 0 ? `${open} חסרות` : "מאויש מלא"}
          </div>
        </div>
      );
    })}
  </div>
</section>


      {dashboardData.pendingUpdates &&
        dashboardData.pendingUpdates.length > 0 && (
          <section className="mb-8 animate-pulse-slow">
            <div className="bg-amber-50 border-2 border-amber-200 rounded-2xl p-6 shadow-sm">
              <div className="flex items-center gap-3 mb-4 text-amber-800">
                <div className="bg-amber-500 text-white p-2 rounded-lg">
                  <AlertCircle size={24} />
                </div>
                <div>
                  <h2 className="text-xl font-bold">
                    ישנם {dashboardData.pendingUpdates.length} שיבוצים מהעבר
                    שממתינים לעדכון
                  </h2>
                  <p className="text-sm">
                    אנא עדכני האם הגנים אוישו או נסגרו כדי לשמור על סדר המערכת.
                  </p>
                </div>
              </div>

              <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                {dashboardData.pendingUpdates.map((item: any) => (
                  <div
                    key={item.id}
                    className="bg-white border border-amber-100 p-4 rounded-xl flex items-center justify-between"
                  >
                    <div>
                      <p className="font-bold text-slate-800">
                        {item.institution.name}
                      </p>
                      <p className="text-xs text-slate-500">
                        {item.mainTeacher.firstName} {item.mainTeacher.lastName}
                      </p>
                      <p className="text-xs font-bold text-amber-600 mt-1">
                        תאריך: {format(new Date(item.date), "dd/MM/yyyy")}
                      </p>
                    </div>
                    <div className="flex gap-2">
                      <button
                        onClick={() => {
                          setSelectedPlacement(item);
                          setIsModalOpen(true);
                        }}
                        className="text-xs bg-slate-800 text-white px-3 py-2 rounded-lg font-bold hover:bg-slate-700 transition-all"
                      >
                        עדכון שיבוץ
                      </button>
                      <button
                        onClick={() => handleCloseGarden(item.id)}
                        className="text-xs border border-amber-300 text-amber-700 px-3 py-2 rounded-lg font-bold hover:bg-amber-100 transition-all"
                      >
                        הגן נסגר
                      </button>
                    </div>
                  </div>
                ))}
              </div>
            </div>
          </section>
        )}
      {dashboardData.pendingUpdates &&
        dashboardData.pendingUpdates.length > 0 && (
          <div className="mb-8 bg-orange-50 border-r-4 border-orange-500 p-6 rounded-xl shadow-sm">
            <div className="flex items-center gap-3 mb-4">
              <AlertCircle className="text-orange-600" size={28} />
              <h2 className="text-xl font-bold text-orange-900">
                יש לעדכן נתונים מהעבר ({dashboardData.pendingUpdates.length})
              </h2>
            </div>
            <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
              {dashboardData.pendingUpdates.map((alert: any) => (
                <div
                  key={alert.id}
                  className="bg-white p-4 rounded-lg border border-orange-100 flex justify-between items-center shadow-sm"
                >
                  <div>
                    <p className="font-bold">{alert.institution.name}</p>
                    <p className="text-xs text-slate-500">
                      {alert.mainTeacher.firstName} {alert.mainTeacher.lastName}
                    </p>
                    <p className="text-xs text-orange-600 font-bold">
                      {format(new Date(alert.date), "dd/MM")}
                    </p>
                  </div>
                  <div className="flex gap-1">
                    <button
                      onClick={() => {
                        setSelectedPlacement(alert);
                        setIsModalOpen(true);
                      }}
                      className="bg-slate-800 text-white text-[10px] px-2 py-1.5 rounded hover:bg-slate-700 font-bold"
                    >
                      עדכון
                    </button>
                    <button
                      onClick={() => handleCloseGarden(alert.id)}
                      className="border border-red-200 text-red-600 text-[10px] px-2 py-1.5 rounded hover:bg-red-50 font-bold"
                    >
                      סגירה
                    </button>
                  </div>
                </div>
              ))}
            </div>
          </div>
        )}
      <div className="grid grid-cols-1 lg:grid-cols-3 gap-8">
        <div className="lg:col-span-2 space-y-4">
          <h2 className="text-xl font-bold flex items-center gap-2 text-red-600 italic">
            🚨 קריאות דחופות
          </h2>
          {dashboardData.urgentAlerts.map((alert: any) => (
            <div
              key={alert.id}
              className="bg-white p-5 rounded-2xl border border-slate-100 flex items-center justify-between shadow-sm text-black"
            >
              <div>
                <p className="font-bold text-lg">{alert.institution.name}</p>
                <p className="text-sm text-slate-500">
                  {alert.mainTeacher.firstName} {alert.mainTeacher.lastName}
                </p>
                <p className="text-xs text-blue-600 font-bold mt-1">
                  {format(new Date(alert.date), "dd/MM/yyyy")}
                </p>
              </div>

              <div className="flex gap-2">
                <button
                  onClick={() => {
                    setSelectedPlacement(alert);
                    setIsModalOpen(true);
                  }}
                  className="bg-slate-900 text-white px-5 py-2 rounded-xl text-sm font-bold hover:bg-emerald-600 transition-all shadow-md"
                >
                  שבצי מחליפה
                </button>
                <button
                  onClick={() => handleCloseGarden(alert.id)}
                  className="bg-white text-red-600 border border-red-200 px-5 py-2 rounded-xl text-sm font-bold hover:bg-red-50 transition-all shadow-sm"
                >
                  סגירת הגן
                </button>
              </div>
            </div>
          ))}

          {dashboardData.urgentAlerts.length === 0 && (
            <div className="bg-emerald-50 text-emerald-700 p-6 rounded-2xl text-center font-bold border border-emerald-100">
              אין קריאות דחופות
            </div>
          )}
        </div>

        {/* עדכונים */}
        <div className="bg-white p-6 rounded-2xl border border-slate-100 shadow-sm text-black">
          <h2 className="font-bold mb-4 flex items-center gap-2">
            <Clock className="w-4 h-4" /> עדכונים אחרונים
          </h2>
          {dashboardData.recentActivity.map((act: any) => (
            <div
              key={act.id}
              className="text-sm border-r-2 border-blue-100 pr-3 mb-4"
            >
              <p className="font-medium text-slate-700">
                {act.status === "CANCELLED"
                  ? `הגן ${act.institution.name} נסגר להיום`
                  : act.substitute
                  ? `שובצה ${act.substitute.firstName} לגן ${act.institution.name}`
                  : `דווחה היעדרות ב${act.institution.name}`}
              </p>
              <p className="text-[10px] text-slate-400">
                {format(new Date(act.updatedAt || act.date), "HH:mm")}
              </p>
            </div>
          ))}
        </div>
      </div>

      {selectedPlacement && (
        <PlacementModal
          isOpen={isModalOpen}
          placement={selectedPlacement}
          onClose={() => setIsModalOpen(false)}
          onSuccess={loadData}
        />
      )}
    </div>
  );
}


    [DIR] placements

      [FILE] page.tsx
"use client";

import { useEffect, useState } from "react";
import PlacementModal from "@/components/PlacementModal";
import InstructorPlacementsModal from "@/components/InstructorPlacementsModal";
import { highlightText } from "@/lib/utils/formatters";
import AddInstitutionModal from "@/components/AddInstitutionModal";
import { isRegistrationOpen } from "@/utils/dateHelpers";
import AddUserModal from "@/components/AddUserModal.tsx";

export default function SupervisorPlacements() {
  const [data, setData] = useState<any[]>([]);
  const [loading, setLoading] = useState(true);
  const [searchTerm, setSearchTerm] = useState("");

  // מודאל 1: רשימת הגננות של מדריכה
  const [isInstructorModalOpen, setIsInstructorModalOpen] = useState(false);
  const [activeInstructor, setActiveInstructor] = useState<any>(null);

  // מודאל 2: שיבוץ מחליפה
  const [isAssignModalOpen, setIsAssignModalOpen] = useState(false);
  const [selectedPlacement, setSelectedPlacement] = useState<any>(null);

  // מודאל 3: הוספת גננת אם חדשה
  const [isAddTeacherOpen, setIsAddTeacherOpen] = useState(false);

  // מודאל 4: הוספת מוסד
  const [isAddInstitutionOpen, setIsAddInstitutionOpen] = useState(false);

  const loadData = () => {
    setLoading(true);
    fetch("/api/supervisor/placements")
      .then((res) => res.json())
      .then((json) => {
        setData(json);
        setLoading(false);
      })
      .catch(() => setLoading(false));
  };

  useEffect(() => {
    loadData();
  }, []);

  const openInstructorModal = (instructor: any) => {
    setActiveInstructor(instructor);
    setIsInstructorModalOpen(true);
  };

  const openAssignModal = (placement: any) => {
    setSelectedPlacement(placement);
    setIsAssignModalOpen(true);
  };



  if (loading)
    return (
      <div className="min-h-screen flex items-center justify-center bg-gray-50">
        <div className="text-center">
          <div className="inline-block animate-spin rounded-full h-16 w-16 border-4 border-slate-700 border-t-transparent mb-4"></div>
          <p className="text-xl font-semibold text-gray-700">טוען נתונים...</p>
        </div>
      </div>
    );

  const filteredData = data.filter((instructor) => {
    const instructorName =
      `${instructor.firstName} ${instructor.lastName}`.toLowerCase();
    const hasMatchingGanenet = instructor.subordinatesIns?.some((g: any) =>
      `${g.firstName} ${g.lastName}`
        .toLowerCase()
        .includes(searchTerm.toLowerCase())
    );
    return (
      instructorName.includes(searchTerm.toLowerCase()) || hasMatchingGanenet
    );
  });

  return (
    <div className="min-h-screen bg-gray-50 font-sans" dir="rtl">
      {/* Header Section */}
      <div className="bg-white border-b border-gray-200 shadow-sm">
        <div className="max-w-7xl mx-auto px-6 py-8">
          <div className="flex flex-col lg:flex-row lg:items-center justify-between gap-6">
            <div>
              <h1 className="text-4xl font-bold text-slate-800 mb-2">
                ניהול שיבוצים והדרכה
              </h1>
              <p className="text-gray-600">מערכת ניהול מדריכות וגננות</p>
            </div>
          </div>
        </div>
      </div>

      {/* Main Content */}
      <div className="max-w-7xl mx-auto px-6 py-8">
        {/* Action Buttons */}
        <div className="flex flex-wrap gap-4 mb-8">
          <button
            onClick={() => setIsAddTeacherOpen(true)}
            className="bg-slate-700 hover:bg-slate-800 text-white px-6 py-3 rounded-lg font-semibold flex items-center gap-2 transition-all shadow-md hover:shadow-lg"
          >
            <span className="text-xl">+</span>
            הוספת גננת אם חדשה
          </button>

          <button
            onClick={() => setIsAddInstitutionOpen(true)}
            className="bg-slate-600 hover:bg-slate-700 text-white px-6 py-3 rounded-lg font-semibold flex items-center gap-2 transition-all shadow-md hover:shadow-lg"
          >
            <span className="text-xl">+</span>
            הוספת גן חדש
          </button>
        </div>

        {/* Section Title */}
        <div className="mb-6">
          <h2 className="text-2xl font-bold text-slate-800 flex items-center gap-3">
            <span className="w-1 h-8 bg-slate-700 rounded"></span>
            רשימת מדריכות
            <span className="text-sm font-normal text-gray-500 mr-2">
              ({filteredData.length} מדריכות)
            </span>
          </h2>
        </div>

        <div className="flex flex-col sm:flex-row gap-3 mb-8">
          <div className="relative">
            <input
              type="text"
              placeholder="חיפוש מדריכה או גננת..."
              className="w-full sm:w-80 px-5 text-gray-700 py-3 pr-12 border border-gray-300 rounded-lg focus:ring-2 focus:ring-slate-600 focus:border-slate-600 outline-none shadow-sm transition-all placeholder-black bg-white"
              value={searchTerm}
              onChange={(e) => setSearchTerm(e.target.value)}
            />
            <span className="absolute right-4 top-1/2 -translate-y-1/2 text-gray-400">
              🔍
            </span>
          </div>
        </div>

        {/* Instructors Grid */}
        <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
          {filteredData.map((instructor: any) => {
            const teacherCount =
              instructor.subordinatesIns?.filter((g: any) =>
                g.roles.includes("MANAGER")
              ).length || 0;

            return (
              <div
                key={instructor.id}
                onClick={() => openInstructorModal(instructor)}
                className="group bg-white rounded-lg shadow-md border border-gray-200 hover:border-slate-400 hover:shadow-xl transition-all duration-300 cursor-pointer overflow-hidden"
              >
                <div className="bg-slate-700 p-6 text-white">
                  <div className="flex justify-between items-start mb-4">
                    <h2 className="text-2xl font-bold leading-tight">
                      {highlightText(
                        `${instructor.firstName} ${instructor.lastName}`,
                        searchTerm
                      )}
                    </h2>
                    <div className="bg-slate-600 px-3 py-1.5 rounded group-hover:bg-slate-500 transition-colors">
                      <span className="text-xs font-semibold">לחצי לצפייה</span>
                    </div>
                  </div>

                  <div className="items-center gap-2 bg-slate-600 px-4 py-2 rounded inline-flex">
                    <span className="text-2xl font-bold">{teacherCount}</span>
                    <span className="text-sm">גננות אם</span>
                  </div>
                </div>

                <div className="p-5 bg-gray-50 border-t border-gray-200">
                  <div className="flex items-center justify-between">
                    <div className="flex items-center gap-2 text-gray-700">
                      <span className="text-xl">👥</span>
                      <span className="text-sm font-medium">
                        ניהול גנים ושיבוצים
                      </span>
                    </div>
                    <div className="text-slate-700 font-semibold text-sm group-hover:translate-x-1 transition-transform">
                      פרטים ←
                    </div>
                  </div>
                </div>
              </div>
            );
          })}
        </div>

        {/* Empty State */}
        {filteredData.length === 0 && (
          <div className="text-center py-16">
            <div className="text-6xl mb-4">🔍</div>
            <h3 className="text-2xl font-bold text-gray-700 mb-2">
              לא נמצאו תוצאות
            </h3>
            <p className="text-gray-500">נסה לשנות את מילות החיפוש</p>
          </div>
        )}
      </div>

      {/* Modals */}
      <InstructorPlacementsModal
        isOpen={isInstructorModalOpen}
        onClose={() => setIsInstructorModalOpen(false)}
        instructor={activeInstructor}
        searchTerm={searchTerm}
        onAssignClick={(placement) => openAssignModal(placement)}
      />

      {selectedPlacement && (
        <PlacementModal
          isOpen={isAssignModalOpen}
          placement={selectedPlacement}
          onClose={() => setIsAssignModalOpen(false)}
          onSuccess={() => {
            loadData();
            setIsAssignModalOpen(false);
          }}
        />
      )}

      <AddUserModal
        isOpen={isAddTeacherOpen}
        onClose={() => setIsAddTeacherOpen(false)}
        onSuccess={() => {
          loadData();
        }}
      />

      <AddInstitutionModal
        isOpen={isAddInstitutionOpen}
        onClose={() => setIsAddInstitutionOpen(false)}
        onSuccess={() => {
          loadData();
        }}
      />
    </div>
  );
}

  [DIR] supervisor-placements

    [FILE] module.css
.container {
  padding: 2rem;
  min-height: 100vh;
  direction: rtl;
  background-color: var(--bg-primary);
  color: var(--text-primary);
}

.header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-bottom: 2rem;
}

.title {
  font-size: 1.875rem;
  font-weight: 700;
}

.refreshButton {
  padding: 0.5rem;
  border-radius: 9999px;
  border: none;
  background: var(--card-bg);
  box-shadow: 0 1px 3px rgba(0,0,0,0.1);
  cursor: pointer;
  transition: background 0.2s;
}

.listGrid {
  display: flex;
  flex-direction: column;
  gap: 1rem;
}

.card {
  background: var(--card-bg);
  padding: 1.25rem;
  border-radius: 0.75rem;
  border: 1px solid var(--border-color);
  display: flex;
  align-items: center;
  justify-content: space-between;
  transition: transform 0.2s;
}

.dateBox {
  text-align: center;
  background: var(--accent-soft);
  padding: 0.75rem;
  border-radius: 0.5rem;
  min-width: 80px;
}

.dayName {
  font-size: 0.875rem;
  color: var(--accent-main);
  font-weight: 700;
}

.dayNumber {
  font-size: 1.25rem;
  font-weight: 900;
  color: var(--accent-dark);
}

.statusBadge {
  padding: 0.25rem 0.75rem;
  border-radius: 9999px;
  font-size: 0.75rem;
  font-weight: 700;
}

.status-OPEN { background: #fef3c7; color: #92400e; }
.status-ASSIGNED { background: #dcfce7; color: #166534; }
.status-CANCELLED { background: #f3f4f6; color: #374151; }

.btnPrimary {
  background: var(--primary-blue);
  color: white;
  padding: 0.5rem 1.5rem;
  border-radius: 0.5rem;
  font-weight: 700;
  border: none;
  cursor: pointer;
}

.btnDanger {
  color: #dc2626;
  border: 1px solid #fecaca;
  padding: 0.5rem 1rem;
  border-radius: 0.5rem;
  background: transparent;
  cursor: pointer;
}

/* Variables for Light/Dark Mode (to be put in globals.css) */
:root {
  --bg-primary: #f9fafb;
  --text-primary: #111827;
  --card-bg: #ffffff;
  --border-color: #f3f4f6;
  --accent-soft: #eff6ff;
  --accent-main: #2563eb;
  --accent-dark: #1e3a8a;
  --primary-blue: #2563eb;
}

[data-theme='dark'] {
  --bg-primary: #111827;
  --text-primary: #f9fafb;
  --card-bg: #1f2937;
  --border-color: #374151;
  --accent-soft: #1e3a8a;
  --accent-main: #60a5fa;
  --accent-dark: #dbeafe;
}

    [FILE] page.tsx
"use client"; // חובה ב-Next.js עבור דפי אינטראקציה

import { useState, useEffect } from 'react';
import { callApi } from '@/lib/api';
import { Trash2, CheckCircle, AlertTriangle, RefreshCw } from 'lucide-react';
import styles from './placement-management.module.css';
export default function PlacementsManagement() {
  const [placements, setPlacements] = useState<any[]>([]);
  const [loading, setLoading] = useState(true);
  const [error, setError] = useState<string | null>(null);

  // מזהה המפקחת (בהמשך יגיע ממערכת ההתחברות שלך)
  const managerId = "694c4dcf64912e523aeee974"; 

  // טעינת הנתונים (נשתמש בנתוני דצמבר 2024 כדוגמה)
  const loadData = async () => {
    try {
      setLoading(true);
      // כאן אנחנו קוראים לפונקציה של לוח השנה שקיימת ב-Service שלך
      const data = await callApi("getCalendarData", { month: 12, year: 2024 });
      setPlacements(data);
    } catch (err) {
      alert("שגיאה בטעינת הנתונים");
    } finally {
      setLoading(false);
    }
  };

  useEffect(() => {
    loadData();
  }, []);

  // פונקציה לביטול גן
  const handleCancel = async (placementId: string) => {
    if (!confirm("האם לסגור את הגן ולבטל את השיבוץ?")) return;

    try {
      await callApi("updateStatus", {
        placementId,
        newStatus: "CANCELLED",
        managerId
      });
      alert("הגן בוטל בהצלחה");
      loadData(); // רענון הנתונים
    } catch (err: any) {
      alert(err.message);
    }
  };

  if (loading) return <div className="p-10 text-center">טוען נתונים...</div>;

return (
    <div className={styles.container}>
      <header className={styles.header}>
        <h1 className={styles.title}>ניהול שיבוצים - מפקחת</h1>
        <button onClick={loadData} className={styles.refreshButton}>
          <RefreshCw size={20} />
        </button>
      </header>

      <div className={styles.listGrid}>
        {placements.map((p) => (
          <div key={p.id} className={styles.card}>
            <div style={{ display: 'flex', gap: '1.5rem', alignItems: 'center' }}>
              <div className={styles.dateBox}>
                <div className={styles.dayName}>
                  {new Date(p.date).toLocaleDateString('he-IL', { weekday: 'short' })}
                </div>
                <div className={styles.dayNumber}>
                  {new Date(p.date).getDate()}
                </div>
              </div>

              <div>
                <h3 style={{ fontWeight: 700 }}>{p.institution.name}</h3>
                <p style={{ color: 'var(--text-secondary)', fontSize: '0.9rem' }}>
                  גננת אם: {p.mainTeacher.firstName} {p.mainTeacher.lastName}
                </p>
              </div>

              <div>
                <span className={`${styles.statusBadge} ${styles[`status-${p.status}`]}`}>
                  {p.status === 'OPEN' ? 'ממתין' : p.status === 'ASSIGNED' ? 'משובץ' : 'בוטל'}
                </span>
              </div>
            </div>

            <div style={{ display: 'flex', gap: '0.75rem' }}>
              {p.status !== 'CANCELLED' && (
                <button onClick={() => handleCancel(p.id)} className={styles.btnDanger}>
                  <Trash2 size={18} />
                </button>
              )}
              {p.status === 'OPEN' && (
                <button className={styles.btnPrimary}>שבצי מחליפה</button>
              )}
            </div>
          </div>
        ))}
      </div>
    </div>
  );
}

[DIR] components

  [FILE] AddInstitutionModal.tsx
"use client";
import { useState, useEffect } from "react";
import { X, Search } from "lucide-react";

export default function AddInstitutionModal({ isOpen, onClose, onSuccess }: any) {
  const [managers, setManagers] = useState<any[]>([]);
  const [searchTerm, setSearchTerm] = useState("");
  const [loading, setLoading] = useState(false);

  useEffect(() => {
    if (isOpen) {
      fetch("/api/supervisor/managers")
        .then(res => res.json())
        .then(data => setManagers(Array.isArray(data) ? data : []));
    }
  }, [isOpen]);

  // פונקציית סינון לפי חיפוש
  const filteredManagers = managers.filter(m => 
    `${m.firstName} ${m.lastName}`.toLowerCase().includes(searchTerm.toLowerCase())
  );

  const handleSubmit = async (e: any) => {
    e.preventDefault();
    setLoading(true);
    
    const formData = new FormData(e.target);
    const selectedManagerId = formData.get("mainManagerId");
    const selectedManager = managers.find(m => m.id === selectedManagerId);

    const payload = {
      name: formData.get("name"),
      address: formData.get("address"),
      institutionNumber: formData.get("institutionNumber"),
      mainManagerId: selectedManagerId,
      instructorId: selectedManager?.instructorId,
    };

    // שימי לב לכתובת המעודכנת כאן:
    const res = await fetch("/api/supervisor/institutions", {
      method: "POST",
      body: JSON.stringify(payload),
      headers: { "Content-Type": "application/json" },
    });

    if (res.ok) {
      onSuccess();
      onClose();
    } else {
      const err = await res.json();
      alert(err.message || "שגיאה ביצירת הגן");
    }
    setLoading(false);
  };

  if (!isOpen) return null;

  return (
    <div className="fixed inset-0 z-[80] flex items-center justify-center bg-black/60 backdrop-blur-sm p-4 text-black" dir="rtl">
      <div className="bg-white w-full max-w-md rounded-2xl shadow-2xl overflow-hidden">
        <div className="p-6 bg-emerald-700 text-white flex justify-between items-center">
          <h2 className="text-xl font-bold">הקמת גן חדש</h2>
          <button onClick={onClose} className="hover:bg-white/20 rounded-full p-1"><X /></button>
        </div>

        <form onSubmit={handleSubmit} className="p-6 space-y-4">
          <input name="name" required placeholder="שם הגן" className="w-full border p-2 rounded focus:ring-2 focus:ring-emerald-500 placeholder-black outline-none" />
          <input name="address" required placeholder="כתובת" className="w-full border p-2 rounded focus:ring-2 focus:ring-emerald-500 placeholder-black outline-none" />
          <input name="institutionNumber" required placeholder="מספר מוסד" className="w-full border p-2 rounded focus:ring-2  placeholder-black-emerald-500 outline-none" />

          <div className="space-y-2 border-t pt-4">
            <label className="text-sm font-bold text-emerald-800">בחרי גננת אם פנויה:</label>
            
            {/* שדה חיפוש בתוך המודאל */}
            <div className="relative">
              <Search className="absolute right-2 top-2.5 text-gray-400" size={16} />
              <input 
                type="text" 
                placeholder="חפשי גננת..." 
                className="w-full border p-2 pr-8 rounded text-sm placeholder-black bg-gray-50 outline-none focus:border-emerald-500"
                value={searchTerm}
                onChange={(e) => setSearchTerm(e.target.value)}
              />
            </div>

            <select name="mainManagerId" required className="w-full border p-2 rounded bg-white outline-none focus:ring-2 focus:ring-emerald-500">
              <option value="">-- בחרי מרשימה ({filteredManagers.length} נמצאו) --</option>
              {filteredManagers.map((m: any) => (
                <option key={m.id} value={m.id}>{m.firstName} {m.lastName}</option>
              ))}
            </select>
          </div>

          <button 
            type="submit" 
            disabled={loading || managers.length === 0} 
            className="w-full bg-emerald-600 text-white p-3 rounded-xl font-bold hover:bg-emerald-700 disabled:bg-gray-400 transition-all shadow-lg mt-4"
          >
            {loading ? "מקים גן..." : "צור גן חדש"}
          </button>
        </form>
      </div>
    </div>
  );
}

  [FILE] AddUserModal.tsx.tsx
"use client";
import { useState, useEffect } from "react";
import { X } from "lucide-react";

export default function AddUserModal({ isOpen, onClose, onSuccess }: any) {
  const [instructors, setInstructors] = useState<any[]>([]);
  const [selectedRoles, setSelectedRoles] = useState<string[]>([]);
  const [loading, setLoading] = useState(false);

  useEffect(() => {
    if (isOpen) {
      // טעינת רשימת מדריכות בלבד
      fetch("/api/supervisor/instructors")
        .then(res => res.json())
        .then(data => setInstructors(Array.isArray(data) ? data : []))
        .catch(() => setInstructors([]));
    }
  }, [isOpen]);

  const handleRoleChange = (role: string) => {
    setSelectedRoles(prev =>
      prev.includes(role) ? prev.filter(r => r !== role) : [...prev, role]
    );
  };

  const handleSubmit = async (e: any) => {
    e.preventDefault();
    setLoading(true);

    const formData = new FormData(e.target);
    const formProps = Object.fromEntries(formData);

    const payload = {
      ...formProps,
      roles: selectedRoles,
    };

    try {
      const res = await fetch("/api/supervisor/register", {
        method: "POST",
        body: JSON.stringify(payload),
        headers: { "Content-Type": "application/json" },
      });

      if (res.ok) {
        onSuccess();
        onClose();
      } else {
        const err = await res.json();
        alert(err.message || "שגיאה ברישום");
      }
    } catch {
      alert("שגיאת תקשורת עם השרת");
    } finally {
      setLoading(false);
    }
  };

  if (!isOpen) return null;

  const isManager = selectedRoles.includes("MANAGER");
  const hasSelectedRole = selectedRoles.length > 0;

  return (
    <div className="fixed inset-0 z-[70] flex items-center justify-center bg-black/60 backdrop-blur-sm p-4 overflow-y-auto" dir="rtl">
      <div className="bg-white w-full max-w-2xl rounded-2xl shadow-2xl my-auto text-black">
        <div className="p-6 bg-blue-800 text-white flex justify-between items-center rounded-t-2xl">
          <h2 className="text-xl font-bold">רישום משתמשת חדשה</h2>
          <button onClick={onClose} className="hover:bg-white/20 rounded-full p-1"><X /></button>
        </div>

        <form onSubmit={handleSubmit} className="p-6 space-y-4">

          {/* בחירת תפקיד */}
          <div className="bg-blue-50 p-4 rounded-xl border border-blue-100">
            <label className="block font-bold mb-2 text-blue-900 font-sans">בחרי תפקיד:</label>
            <div className="flex gap-6">
              <label className="flex items-center gap-2 cursor-pointer group">
                <input
                  type="checkbox"
                  checked={selectedRoles.includes("MANAGER")}
                  onChange={() => handleRoleChange("MANAGER")}
                  className="w-4 h-4 accent-blue-700"
                />
                <span className="font-medium group-hover:text-blue-700">גננת אם</span>
              </label>
              <label className="flex items-center gap-2 cursor-pointer group">
                <input
                  type="checkbox"
                  checked={selectedRoles.includes("INSTRUCTOR")}
                  onChange={() => handleRoleChange("INSTRUCTOR")}
                  className="w-4 h-4 accent-blue-700"
                />
                <span className="font-medium group-hover:text-blue-700">מדריכה</span>
              </label>
            </div>
          </div>

          {!hasSelectedRole && (
            <div className="text-center text-gray-500 text-sm py-6 animate-pulse">
              יש לבחור תפקיד כדי להמשיך במילוי הטופס
            </div>
          )}

          {hasSelectedRole && (
            <div className="grid grid-cols-1 md:grid-cols-2 gap-4 font-sans transition-all duration-300 ease-in-out">

              <div className="space-y-1">
                <label className="text-xs font-bold mr-1">שם פרטי</label>
                <input name="firstName" required className="w-full border p-2 rounded focus:ring-2 focus:ring-blue-500 outline-none" />
              </div>

              <div className="space-y-1">
                <label className="text-xs font-bold mr-1">שם משפחה</label>
                <input name="lastName" required className="w-full border p-2 rounded focus:ring-2 focus:ring-blue-500 outline-none" />
              </div>

              <div className="space-y-1">
                <label className="text-xs font-bold mr-1">תעודת זהות</label>
                <input name="idNumber" required className="w-full border p-2 rounded focus:ring-2 focus:ring-blue-500 outline-none" />
              </div>

              <div className="space-y-1">
                <label className="text-xs font-bold mr-1">אימייל</label>
                <input name="email" type="email" required className="w-full border p-2 rounded focus:ring-2 focus:ring-blue-500 outline-none" />
              </div>

              <div className="space-y-1">
                <label className="text-xs font-bold mr-1">שם משתמש</label>
                <input name="username" required className="w-full border p-2 rounded focus:ring-2 focus:ring-blue-500 outline-none" />
              </div>

              <div className="space-y-1">
                <label className="text-xs font-bold mr-1">סיסמה</label>
                <input name="password" type="password" required className="w-full border p-2 rounded focus:ring-2 focus:ring-blue-500 outline-none" />
              </div>

              <div className="space-y-1">
                <label className="text-xs font-bold mr-1">טלפון</label>
                <input name="phoneNumber" required className="w-full border p-2 rounded focus:ring-2 focus:ring-blue-500 outline-none" />
              </div>

              <div className="space-y-1">
                <label className="text-xs font-bold mr-1">תאריך לידה</label>
                <input name="dateOfBirth" type="date" required className="w-full border p-2 rounded focus:ring-2 focus:ring-blue-500 outline-none" />
              </div>

              {isManager && (
                <div className="col-span-1 md:col-span-2 grid grid-cols-1 gap-4 bg-gray-50 p-4 rounded-lg border border-dashed border-gray-300">
                  <div className="space-y-1">
                    <label className="text-xs font-bold text-blue-800">מדריכה מלווה</label>
                    <select name="instructorId" required className="w-full border p-2 rounded bg-white outline-none">
                      <option value="">בחרי מדריכה...</option>
                      {Array.isArray(instructors) && instructors.map((i: any) => (
                        <option key={i.id} value={i.id}>{i.firstName} {i.lastName}</option>
                      ))}
                    </select>
                  </div>
                </div>
              )}

            </div>
          )}

          <button
            type="submit"
            disabled={loading || !hasSelectedRole}
            className="w-full bg-blue-700 text-white p-3 rounded-xl font-bold hover:bg-blue-800 disabled:bg-gray-400 transition-all shadow-lg active:scale-95"
          >
            {loading ? "יוצרת משתמשת..." : "סיום והרשמה"}
          </button>

        </form>
      </div>
    </div>
  );
}


  [FILE] CalendarView.tsx
"use client";
import { useState, useEffect } from "react";
import {
  format,
  startOfMonth,
  endOfMonth,
  eachDayOfInterval,
  addMonths,
  subMonths,
  isSameDay,
} from "date-fns";
import { he } from "date-fns/locale";

export default function CalendarView({
  supervisorId,
}: {
  supervisorId: string;
}) {
  const [currentDate, setCurrentDate] = useState(new Date());
  const [placements, setPlacements] = useState([]);

  // פונקציה להבאת נתונים
  const fetchMonthData = async () => {
    const month = currentDate.getMonth() + 1;
    const year = currentDate.getFullYear();
    const res = await fetch(
      `/api/calendar?month=${month}&year=${year}&supervisorId=${supervisorId}`
    );
    const data = await res.json();
    setPlacements(data);
  };

  useEffect(() => {
    fetchMonthData();
  }, [currentDate]);

  const days = eachDayOfInterval({
    start: startOfMonth(currentDate),
    end: endOfMonth(currentDate),
  });

  const handleDelete = async (id: string) => {
    if (!confirm("האם את בטוחה שברצונך למחוק את הדיווח הזה לצמיתות?")) return;

    try {
      const res = await fetch(`/api/calendar`, {
        method: "DELETE",
        headers: { "Content-...": "application/json" },
        body: JSON.stringify({ id }),
      });

      if (res.ok) {
        // עדכון ה-State המקומי כדי שהדיווח ייעלם מהמסך מיד
        setPlacements((prev) => prev.filter((p: any) => p.id !== id));
        alert("הדיווח נמחק בהצלחה");
      } else {
        alert("שגיאה במחיקת הדיווח");
      }
    } catch (error) {
      console.error("Delete error:", error);
      alert("תקלה בתקשורת עם השרת");
    }
  };

  return (
    <div className="p-6 bg-white rounded-2xl shadow-xl">
      {/* כותרת וניווט */}
      <div className="flex justify-between items-center mb-8">
        <button
          onClick={() => setCurrentDate(subMonths(currentDate, 1))}
          className="p-2 border rounded hover:bg-gray-50"
        >
          חודש הקודם
        </button>
        <h2 className="text-2xl font-bold capitalize">
          {format(currentDate, "MMMM yyyy", { locale: he })}
        </h2>
        <button
          onClick={() => setCurrentDate(addMonths(currentDate, 1))}
          className="p-2 border rounded hover:bg-gray-50"
        >
          חודש הבא
        </button>
      </div>

      {/* גריד הלוח */}
      <div className="grid grid-cols-7 gap-2 border-t border-r">
        {["ראשון", "שני", "שלישי", "רביעי", "חמישי", "שישי", "שבת"].map(
          (day) => (
            <div
              key={day}
              className="p-2 text-center font-bold bg-gray-100 border-l border-b"
            >
              {day}
            </div>
          )
        )}

        {days.map((day) => {
          const isSaturday = day.getDay() === 6;
          const dayPlacements = placements.filter((p: any) =>
            isSameDay(new Date(p.date), day)
          );

          return (
            <div
              key={day.toString()}
              className={`min-h-[120px] p-2 border-l border-b transition-colors ${
                isSaturday ? "bg-gray-100 text-gray-400" : "hover:bg-blue-50/30"
              }`}
            >
              <span className="text-sm font-medium">{format(day, "d")}</span>

              {isSaturday ? (
                <div className="mt-4 text-center font-bold text-gray-500">
                  יום מנוחה
                </div>
              ) : (
                <div className="mt-2 space-y-1">
                  {dayPlacements.map((p: any) => (
                    <div
                      key={p.id}
                      className="text-[10px] p-1.5 bg-white border rounded shadow-sm group relative"
                    >
                      <p>
                        <strong>גננת אם:</strong> {p.mainTeacher.firstName}
                      </p>
                      <p
                        className={
                          p.status === "OPEN"
                            ? "text-red-500 font-bold"
                            : "text-green-600"
                        }
                      >
                        <strong>מחליפה:</strong>{" "}
                        {p.substitute
                          ? p.substitute.firstName
                          : p.status === "CANCELLED"
                          ? "גן סגור"
                          : "ממתין לעדכון"}
                      </p>
                      <button
                        onClick={() => handleDelete(p.id)}
                        className="hidden group-hover:block absolute top-0 left-0 bg-red-100 text-red-600 px-1 rounded"
                      >
                        X
                      </button>
                    </div>
                  ))}
                </div>
              )}
            </div>
          );
        })}
      </div>
    </div>
  );
}


  [FILE] InstructorPlacementsModal.tsx
"use client";

import { X } from "lucide-react";
import { highlightText } from "@/lib/utils/formatters"; 

interface Props {
  isOpen: boolean;
  onClose: () => void;
  instructor: any;
  searchTerm: string;
  onAssignClick: (placement: any) => void;
}

export default function InstructorPlacementsModal({ isOpen, onClose, instructor, searchTerm, onAssignClick }: Props) {
  if (!isOpen || !instructor) return null;

  const managers = instructor.subordinatesIns?.filter((g: any) => g.roles.includes("MANAGER")) || [];

  return (
    <div className="fixed inset-0 z-50 flex items-center justify-center p-4 bg-black/60 backdrop-blur-sm" dir="rtl">
      <div className="bg-white w-full max-w-2xl rounded-2xl shadow-2xl flex flex-col max-h-[90vh]">
        
        {/* Header */}
        <div className="p-6 border-b flex justify-between items-center bg-blue-600 text-white rounded-t-2xl">
          <div>
            <h2 className="text-2xl font-bold">{instructor.firstName} {instructor.lastName}</h2>
            <p className="text-blue-100 opacity-90 text-sm">ניהול גננות אם ושיבוצים</p>
          </div>
          <button onClick={onClose} className="p-2 hover:bg-white/20 rounded-full transition-colors">
            <X size={24} />
          </button>
        </div>

        {/* Content */}
        <div className="p-6 overflow-y-auto space-y-4">
          {managers.length === 0 ? (
            <div className="text-center py-10 text-gray-500">לא נמצאו גננות אם משויכות למדריכה זו.</div>
          ) : (
            managers.map((ganenet: any) => {
              const todaysPlacement = ganenet.placementsAsMain?.[0];
              return (
                <div key={ganenet.id} className="p-4 bg-gray-50 rounded-xl border border-gray-200 flex justify-between items-center hover:border-blue-300 transition-all">
                  <div>
                    <div className="font-bold text-lg text-slate-800">{ganenet.firstName} {ganenet.lastName}</div>
                    <div className="text-sm text-slate-500">{ganenet.mainManagedInstitutions?.[0]?.name || "ללא מוסד"}</div>
                    
                    {todaysPlacement?.status === "OPEN" && (
                      <button
                        onClick={() => onAssignClick(todaysPlacement)}
                        className="mt-2 px-3 py-1 bg-blue-100 text-blue-700 rounded-md text-xs font-bold hover:bg-blue-200 transition-colors"
                      >
                        + חפשי מחליפה
                      </button>
                    )}
                  </div>
                </div>
              );
            })
          )}
        </div>
      </div>
    </div>
  );
}

  [FILE] Navbar.tsx
'use client';

import Link from 'next/link';
import { usePathname, useRouter } from 'next/navigation';
import { LayoutDashboard, Calendar, LogOut, PieChartIcon } from 'lucide-react';

export default function Navbar() {
  const router = useRouter();
  const pathname = usePathname();

  const handleLogout = async () => {
    if (!confirm("האם את בטוחה שברצונך להתנתק?")) return;
    await fetch('/api/auth/logout', { method: 'POST' });
    router.push('/login');
    router.refresh();
  };

  // פונקציית עזר לבדיקה אם הקישור פעיל (בשביל העיצוב)
  const isActive = (path: string) => pathname === path;

  return (
    <nav className="bg-white shadow-sm border-b border-gray-200 sticky top-0 z-40">
      <div className="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
        <div className="flex justify-between h-16 items-center">
          
          {/* צד ימין: לוגו ותפריט ניווט */}
          <div className="flex items-center gap-8">
            <div className="flex items-center gap-3">
              <div className="bg-blue-600 text-white p-2 rounded-xl font-bold shadow-md shadow-blue-100">FitIn</div>
              <span className="text-lg font-extrabold text-slate-800 hidden md:block">ממשק מפקחת</span>
            </div>

            <div className="flex items-center gap-2">
              <Link 
                href="/supervisor" 
                className={`flex items-center gap-2 px-4 py-2 rounded-xl text-sm font-bold transition-all ${
                  isActive('/supervisor') 
                  ? 'bg-blue-50 text-blue-600' 
                  : 'text-slate-500 hover:bg-slate-50 hover:text-slate-700'
                }`}
              >
                <LayoutDashboard size={18} />
                <span>דאשבורד</span>
              </Link>

              <Link 
                href="/supervisor/calendar" 
                className={`flex items-center gap-2 px-4 py-2 rounded-xl text-sm font-bold transition-all ${
                  isActive('/supervisor/calendar') 
                  ? 'bg-blue-50 text-blue-600' 
                  : 'text-slate-500 hover:bg-slate-50 hover:text-slate-700'
                }`}
              >
                <Calendar size={18} />
                <span>לוח שנה</span>
              </Link>
              <Link 
                href="/supervisor/placements" 
                className={`flex items-center gap-2 px-4 py-2 rounded-xl text-sm font-bold transition-all ${
                  isActive('/supervisor/placements') 
                  ? 'bg-blue-50 text-blue-600' 
                  : 'text-slate-500 hover:bg-slate-50 hover:text-slate-700'
                }`}
              >
                <PieChartIcon size={18} />
                <span>נתונים</span>
              </Link>
            </div>
          </div>

          {/* צד שמאל: כפתור התנתקות */}
          <div className="flex items-center">
            <button
              onClick={handleLogout}
              className="flex items-center gap-2 text-sm font-bold text-red-500 hover:bg-red-50 px-4 py-2 rounded-xl transition-all border border-transparent hover:border-red-100"
            >
              <LogOut size={18} />
              <span className="hidden sm:inline">התנתקות</span>
            </button>
          </div>

        </div>
      </div>
    </nav>
  );
}

  [FILE] PlacementModal.tsx
"use client";

import { useState, useEffect } from "react";
import { X, Search, UserCheck, Loader2 } from "lucide-react";
import { format } from "date-fns";
import { he } from "date-fns/locale";

interface PlacementModalProps {
  placement: any;
  isOpen: boolean;
  onClose: () => void;
  onSuccess: () => void;
}

export default function PlacementModal({
  placement,
  isOpen,
  onClose,
  onSuccess,
}: PlacementModalProps) {
  const [substitutes, setSubstitutes] = useState<any[]>([]);
  const [searchQuery, setSearchQuery] = useState("");
  const [loading, setLoading] = useState(true);
  const [isAssigning, setIsAssigning] = useState(false);

  useEffect(() => {
    if (isOpen && placement?.date) {
      setLoading(true);
      const dateParam = encodeURIComponent(
        new Date(placement.date).toISOString()
      );

      fetch(`/api/supervisor/substitutes?date=${dateParam}`)
        .then((res) => res.json())
        .then((data) => {
          setSubstitutes(data);
          setLoading(false);
        })
        .catch((err) => {
          console.error("טעינת מחליפות נכשלה:", err);
          setLoading(false);
        });
    }
  }, [isOpen, placement]);

  const handleAssign = async (substituteId: string) => {
    setIsAssigning(true);
    try {
      const response = await fetch("/api/supervisor/placements", {
        method: "PATCH",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({
          placementId: placement.id,
          substituteId,
          status: "ASSIGNED",
        }),
      });

      if (response.ok) {
        onSuccess?.();
        onClose();
      } else {
        alert("שגיאה בעדכון השיבוץ");
      }
    } catch (error) {
      console.error("Error updating placement:", error);
      alert("שגיאת תקשורת");
    } finally {
      setIsAssigning(false);
    }
  };

  if (!isOpen) return null;

  const filteredSubstitutes = substitutes.filter(
    (s) =>
      `${s.firstName} ${s.lastName}`.includes(searchQuery) ||
      s.phoneNumber?.includes(searchQuery)
  );

  return (
    <div
      className="fixed inset-0 bg-black/60 backdrop-blur-sm flex items-center justify-center z-[100] p-4"
      dir="rtl"
    >
      <div className="bg-white w-full max-w-lg rounded-3xl shadow-2xl overflow-hidden flex flex-col max-h-[85vh]">
        {/* Header */}
        <div className="p-6 bg-slate-900 text-white flex justify-between items-center">
          <div>
            <h3 className="text-xl font-bold italic tracking-tight">
              שיבוץ מחליפה
            </h3>
            <p className="text-slate-400 text-sm">
              גן: {placement.institution?.name} |{" "}
              {format(new Date(placement.date), "dd/MM/yyyy", { locale: he })}
            </p>
          </div>
          <button
            onClick={onClose}
            className="p-2 hover:bg-white/10 rounded-full transition-colors"
          >
            <X className="w-6 h-6" />
          </button>
        </div>

        {/* Search */}
        <div className="p-4 border-b bg-slate-50">
          <div className="relative">
            <Search className="absolute right-3 top-3 text-slate-400 w-5 h-5" />
            <input
              type="text"
              placeholder="חפשי לפי שם או טלפון..."
              className="w-full pr-10 pl-4 py-3 placeholder-black bg-white border border-slate-200 rounded-xl text-sm focus:ring-2 focus:ring-blue-500 outline-none"
              value={searchQuery}
              onChange={(e) => setSearchQuery(e.target.value)}
              autoFocus
            />
          </div>
        </div>

        {/* List */}
        <div className="flex-1 overflow-y-auto p-4 space-y-2 bg-white">
          {loading ? (
            <div className="flex flex-col items-center justify-center p-10 space-y-3">
              <Loader2 className="animate-spin text-blue-500 w-8 h-8" />
              <p className="text-slate-400 text-sm font-medium">
                בודק זמינות מחליפות...
              </p>
            </div>
          ) : filteredSubstitutes.length === 0 ? (
            <div className="text-center py-12 px-6 bg-slate-50 rounded-2xl border-2 border-dashed border-slate-200">
              <div className="bg-slate-200 w-12 h-12 rounded-full flex items-center justify-center mx-auto mb-4">
                <UserCheck className="text-slate-400 w-6 h-6" />
              </div>
              <p className="text-slate-900 font-bold text-lg mb-1">
                אין מחליפות פנויות
              </p>
              <p className="text-slate-500 text-sm">
                {`לא נמצאו מחליפות ליום ${format(
                  new Date(placement.date),
                  "EEEE",
                  { locale: he }
                )}`}
              </p>

              <button
                onClick={() => setSearchQuery("")}
                className="mt-4 text-blue-600 text-sm font-bold hover:underline"
              >
                נסי לנקות את החיפוש
              </button>
            </div>
          ) : (
            filteredSubstitutes.map((sub) => (
              <div
                key={sub.id}
                className="flex items-center justify-between p-4 rounded-2xl hover:bg-blue-50 transition"
              >
                <div className="flex items-center gap-3">
                  <div className="w-10 h-10 bg-blue-600 text-white rounded-full flex items-center justify-center font-bold">
                    {sub.firstName[0]}
                  </div>
                  <div>
                    <p className="font-bold">
                      {sub.firstName} {sub.lastName}
                    </p>
                    <p className="text-xs text-slate-500">{sub.phoneNumber}</p>
                  </div>
                </div>
                <button
                  disabled={isAssigning}
                  onClick={() => handleAssign(sub.id)}
                  className="flex items-center gap-1 px-4 py-2 bg-emerald-50 text-emerald-600 rounded-xl font-bold text-xs hover:bg-emerald-600 hover:text-white disabled:opacity-50"
                >
                  {isAssigning ? (
                    <Loader2 className="w-4 h-4 animate-spin" />
                  ) : (
                    <>
                      {" "}
                      <UserCheck className="w-4 h-4" /> שבצי עכשיו{" "}
                    </>
                  )}
                </button>
              </div>
            ))
          )}
        </div>
      </div>
    </div>
  );
}


[DIR] lib

  [FILE] api.ts

export async function callApi(type: string, data: any) {
  const response = await fetch('/api/test', {
    method: 'POST',
    headers: {
      'Content-Type': 'application/json',
    },
    body: JSON.stringify({ type, data }),
  });

  if (!response.ok) {
    const error = await response.json();
    throw new Error(error.message || 'משהו השתבש בקריאת ה-API');
  }

  return response.json();
}

  [FILE] auth.ts
import { SignJWT, jwtVerify } from 'jose';
import { cookies } from 'next/headers';
import { NextRequest, NextResponse } from 'next/server';

const SECRET_KEY = new TextEncoder().encode(
  process.env.JWT_SECRET || 'fallback-secret-key-change-me'
);

export async function encrypt(payload: any) {
  return await new SignJWT(payload)
    .setProtectedHeader({ alg: 'HS256' })
    .setIssuedAt()
    .setExpirationTime('2h') // הטוקן יפוג אחרי שעתיים
    .sign(SECRET_KEY);
}

export async function decrypt(input: string): Promise<any> {
  const { payload } = await jwtVerify(input, SECRET_KEY, {
    algorithms: ['HS256'],
  });
  return payload;
}

export async function getSession() {
  const cookieStore = await cookies();
  const session = cookieStore.get('session')?.value;
  
  if (!session) return null;
  return await decrypt(session);
}

  [FILE] prisma.ts
import { PrismaClient } from "@prisma/client";

// הגדרה שתמנע יצירת מופעים מרובים של Prisma ב-Development
const globalForPrisma = global as unknown as { prisma: PrismaClient };

export const prisma =
  globalForPrisma.prisma ||
  new PrismaClient({
    log: ["query"], // אופציונלי: מדפיס לטרמינל את השאילתות שנשלחות ל-DB
  });

if (process.env.NODE_ENV !== "production") globalForPrisma.prisma = prisma;

  [DIR] utils

    [FILE] formatters.tsx
  // פונקציית ההדגשה בצהוב
  export const highlightText = (text: string, highlight: string) => {
    if (!highlight.trim()) return text;
    const parts = text.split(new RegExp(`(${highlight})`, "gi"));
    return (
      <span>
        {parts.map((part, i) =>
          part.toLowerCase() === highlight.toLowerCase() ? (
            <mark key={i} className="bg-yellow-200 px-0.5 rounded">
              {part}
            </mark>
          ) : (
            part
          )
        )}
      </span>
    );
  };

[FILE] middleware.ts
import { NextRequest, NextResponse } from 'next/server';
import { decrypt } from '@/lib/auth';

export async function middleware(request: NextRequest) {
  const session = request.cookies.get('session')?.value;
  const { pathname } = request.nextUrl;

  // הגנה על נתיבי ה-supervisor
  if (pathname.startsWith('/supervisor')) {
    if (!session) {
      return NextResponse.redirect(new URL('/login', request.url));
    }

    try {
      const payload = await decrypt(session);
      // בדיקה אם המשתמש הוא אכן supervisor
      if (!payload.roles.includes('SUPERVISOR')) {
        return NextResponse.redirect(new URL('/', request.url)); // חזרה לדף הבית אם אין הרשאה
      }
    } catch (err) {
      return NextResponse.redirect(new URL('/login', request.url));
    }
  }

  return NextResponse.next();
}

// הגדרה על אילו נתיבים ה-Middleware ירוץ
export const config = {
  matcher: ['/supervisor/:path*'],
};

[DIR] services

  [FILE] authService.ts
import bcrypt from "bcrypt";
import jwt from "jsonwebtoken";
import { encrypt } from "../utils/crypto";
import { prisma } from "@/lib/prisma";

export async function db_registerUser(userData: any) {
  const {
    password,
    idNumber,
    dateOfBirth,
    supervisorId,
    instructorId,
    ...rest
  } = userData;

  const hashedPassword = await bcrypt.hash(password, 10);
  const encryptedID = encrypt(idNumber);
  const existing = await prisma.user.findUnique({
    where: { username: rest.username },
  });
  if (existing) throw new Error("שם משתמש כבר קיים");

  return await prisma.user.create({
    data: {
      ...rest,
      password: hashedPassword,
      idNumber: encryptedID,
      dateOfBirth: new Date(dateOfBirth),
      // הוספת ה-IDs של המנהלות אם קיימים
      supervisorId: supervisorId || null,
      instructorId: instructorId || null,
    },
  });
}

export async function db_login(username: string, password: string) {
  const user = await prisma.user.findUnique({ where: { username } });
  if (!user || !(await bcrypt.compare(password, user.password))) {
    throw new Error("שם משתמש או סיסמה שגויים");
  }

  const token = jwt.sign(
    { userId: user.id, roles: user.roles },
    process.env.JWT_SECRET as string,
    { expiresIn: "30d" }
  );

  const { password: _, ...userWithoutPassword } = user;
  return { token, user: userWithoutPassword };
}


  [FILE] institutionService.ts
import { PrismaClient } from "@prisma/client";
const prisma = new PrismaClient();

export async function db_createInstitution(data: {
  name: string;
  address: string;
  institutionNumber: string;
  supervisorId: string;
  instructorId: string;
  mainManagerId: string;
}) {
  return await prisma.institution.create({
    data
  });
}

export async function db_getAllInstitutions() {
  return await prisma.institution.findMany({
    include: { 
      users: true,
      supervisor: { select: { firstName: true, lastName: true } },
      instructor: { select: { firstName: true, lastName: true } }
    },
  });
}

// מציאת כל המוסדות שתחת מפקחת ספציפית
export async function db_getInstitutionsBySupervisor(supervisorId: string) {
    return await prisma.institution.findMany({
      where: { supervisorId }
    });
}

  [FILE] notificationService.ts
import { PrismaClient } from "@prisma/client";
const prisma = new PrismaClient();

export async function db_createNotification(data: {
  userId: string;
  title: string;
  message: string;
  type: "URGENT_CALL" | "STATUS_UPDATE" | "SYSTEM";
}) {
  return await prisma.notification.create({
    data: {
      userId: data.userId,
      title: data.title,
      message: data.message,
      type: data.type,
      status: "PENDING",
    },
  });
}

// פונקציה לשליחת התראה למספר משתמשים במקביל (למשל לכל המחליפות)
export async function db_notifyMultipleUsers(
  userIds: string[], 
  title: string, 
  message: string, 
  type: "URGENT_CALL" | "STATUS_UPDATE" | "SYSTEM" = "URGENT_CALL" // ברירת מחדל
) {
  const notifications = userIds.map(id => ({
    userId: id,
    title,
    message,
    type,
    status: "PENDING",
  }));

  return await prisma.notification.createMany({
    data: notifications,
  });
}

  [FILE] placementService.ts
import { prisma } from "@/lib/prisma";
import {
  db_createNotification,
  db_notifyMultipleUsers,
} from "./notificationService";
import { Day } from "@prisma/client";
import { startOfDay, endOfDay, addDays } from "date-fns";

/**
 * שליפת נתונים ללוח הבקרה של המפקחת
 */
export async function db_getSupervisorDashboard(supervisorId: string) {
  const today = startOfDay(new Date());
  const endOfWeek = endOfDay(addDays(today, 5));

  // --- פונקציית עזר לחישוב דילוג שבת ---
  const getTargetDate = (startDate: Date, daysToCount: number) => {
    let currentDate = new Date(startDate);
    let addedDays = 0;
    while (addedDays < daysToCount) {
      currentDate = addDays(currentDate, 1);
      if (currentDate.getDay() !== 6) {
        // 6 = יום שבת
        addedDays++;
      }
    }
    return endOfDay(currentDate);
  };

  // חישוב תאריך היעד לקריאות דחופות (3 ימי פעילות קדימה)
  const urgentDeadline = getTargetDate(today, 2);

  // 1. חוסרים מהעבר (Pending Updates)
  const pendingUpdates = await prisma.placement.findMany({
    where: {
      institution: { supervisorId: supervisorId },
      status: "OPEN",
      date: { lt: today },
    },
    include: {
      institution: { select: { name: true } },
      mainTeacher: { select: { firstName: true, lastName: true } },
    },
    orderBy: { date: "desc" },
  });

  // 2. קריאות דחופות (כולל דילוג שבת)
  const urgentAlerts = await prisma.placement.findMany({
    where: {
      institution: { supervisorId: supervisorId },
      status: "OPEN",
      date: { gte: today, lte: urgentDeadline,  },
    },
    include: {
      institution: { select: { name: true } },
      mainTeacher: { select: { firstName: true, lastName: true } },
    },
    orderBy: { date: "asc" },
  });

  // 3. Snapshot שבועי
  const weeklyPlacements = await prisma.placement.findMany({
    where: {
      institution: { supervisorId: supervisorId },
      date: { gte: today, lte: endOfWeek },
    },
    select: { date: true, status: true },
  });

  // 4. פעולות אחרונות
  const recentActivity = await prisma.placement.findMany({
    where: { institution: { supervisorId: supervisorId } },
    take: 5,
    orderBy: { createdAt: "desc" },
    include: {
      institution: { select: { name: true } },
      substitute: { select: { firstName: true, lastName: true } },
      mainTeacher: { select: { firstName: true, lastName: true } },
    },
  });

  return {
    weeklyPlacements,
    urgentAlerts,
    pendingUpdates,
    recentActivity,
  };
}

/**
 * אימות תקינות שיבוץ
 */
export async function validatePlacement(substituteId: string, date: Date) {
  if (date.getDay() === 6) {
    throw new Error("אין פעילות גנים ביום שבת - לא ניתן לשבץ");
  }
  const existingPlacement = await prisma.placement.findFirst({
    where: {
      substituteId,
      date: date,
      status: "ASSIGNED",
    },
  });

  if (existingPlacement) {
    throw new Error("הגננת כבר משובצת לגן אחר בתאריך זה");
  }

  const today = startOfDay(new Date());
  if (date < today) {
    throw new Error("לא ניתן לשבץ לתאריך שכבר עבר");
  }

  return true;
}

const getDayEnum = (date: Date): Day => {
  const days = [
    "SUNDAY",
    "MONDAY",
    "TUESDAY",
    "WEDNESDAY",
    "THURSDAY",
    "FRIDAY",
    "SATURDAY",
  ];
  return days[date.getDay()] as Day;
};

/**
 * יצירת שיבוץ חדש
 */
export async function db_createPlacement(data: {
  date: Date;
  institutionId: string;
  mainTeacherId: string;
  notes?: string;
  creatorRoles: string[];
  status?: "OPEN" | "ASSIGNED" | "CANCELLED";
}) {
  const targetDate = startOfDay(new Date(data.date));
  const today = startOfDay(new Date());
  if (targetDate.getDay() === 6) {
    throw new Error("לא ניתן לדווח על היעדרות ביום שבת");
  }
  const isManager = (data.creatorRoles ?? []).some((role) =>
    ["SUPERVISOR", "INSTRUCTOR"].includes(role)
  );

  const isRetroactive = targetDate < today;

  if (isRetroactive && !isManager) {
    throw new Error("רק מפקחת או מדריכה יכולות לדווח על היעדרות רטרואקטיבית");
  }

  let finalStatus: "OPEN" | "ASSIGNED" | "CANCELLED" = "OPEN";
  if (isRetroactive) {
    if (data.status === "ASSIGNED" || data.status === "CANCELLED") {
      finalStatus = data.status;
    } else {
      throw new Error("בדיווח רטרואקטיבי יש לבחור סטטוס ASSIGNED או CANCELLED");
    }
  } else {
    finalStatus = isManager ? data.status || "OPEN" : "OPEN";
  }

  const existingReport = await prisma.placement.findFirst({
    where: {
      institutionId: data.institutionId,
      date: targetDate,
      status: { not: "CANCELLED" },
    },
  });
  if (existingReport)
    throw new Error("כבר קיים דיווח פעיל לגן זה בתאריך שנבחר");

  const diffInDays =
    (targetDate.getTime() - today.getTime()) / (1000 * 3600 * 24);
  const priority = !isRetroactive && diffInDays <= 2 ? "URGENT" : "NORMAL";

  const newPlacement = await prisma.placement.create({
    data: {
      date: targetDate,
      institutionId: data.institutionId,
      mainTeacherId: data.mainTeacherId,
      notes: data.notes,
      status: finalStatus,
      priority: priority,
    },
    include: {
      institution: true,
      mainTeacher: { select: { firstName: true, lastName: true } },
    },
  });

  if (!isRetroactive && finalStatus === "OPEN") {
    const { institution, mainTeacher } = newPlacement;
    const teacherName = `${mainTeacher.firstName} ${mainTeacher.lastName}`;
    const notificationType =
      priority === "URGENT" ? "URGENT_CALL" : "STATUS_UPDATE";

    await db_createNotification({
      userId: institution.supervisorId,
      title: `דיווח היעדרות: ${institution.name}`,
      message: `גננת האם ${teacherName} דיווחה על היעדרות ל-${targetDate.toLocaleDateString(
        "he-IL"
      )}`,
      type: notificationType,
    });

    const availableTeachers = await prisma.user.findMany({
      where: {
        isWorking: true,
        roles: { hasSome: ["SUBSTITUTE", "ROTATION"] },
        workDays: { has: getDayEnum(targetDate) },
        placementsAsSub: { none: { date: targetDate, status: "ASSIGNED" } },
      },
      select: { id: true },
    });

    const teacherIds = availableTeachers.map((t) => t.id);
    if (teacherIds.length > 0) {
      await db_notifyMultipleUsers(
        teacherIds,
        priority === "URGENT" ? "קריאה דחופה לשיבוץ!" : "הזדמנות לשיבוץ חדש",
        `דרושה מחליפה לגן ${
          institution.name
        } בתאריך ${targetDate.toLocaleDateString("he-IL")}`,
        notificationType
      );
    }
  }

  return newPlacement;
}

/**
 * שיבוץ ידני
 */
export async function db_manualAssign(
  placementId: string,
  substituteId: string,
  managerId: string
) {
  const placement = await prisma.placement.findUnique({
    where: { id: placementId },
  });
  if (!placement) throw new Error("השיבוץ לא נמצא");
  if (placement.status === "CANCELLED") throw new Error("הגן הוגדר כסגור");

  await validatePlacement(substituteId, placement.date);
  return await db_assignSubstitute(placementId, substituteId);
}

/**
 * שיבוץ עצמי
 */
export async function db_selfAssign(placementId: string, substituteId: string) {
  const placement = await prisma.placement.findUnique({
    where: { id: placementId },
    select: { date: true, status: true },
  });

  if (!placement || placement.status !== "OPEN") {
    throw new Error("השיבוץ אינו זמין יותר");
  }

  await validatePlacement(substituteId, placement.date);
  return await db_assignSubstitute(placementId, substituteId);
}

/**
 * עדכון סטטוס
 */
export async function db_updatePlacementStatus(params: {
  placementId: string;
  newStatus: "OPEN" | "ASSIGNED" | "CANCELLED";
  managerId: string;
}) {
  const updated = await prisma.placement.update({
    where: { id: params.placementId },
    data: {
      status: params.newStatus,
      substituteId: params.newStatus === "CANCELLED" ? null : undefined,
    },
    include: { institution: true },
  });

  const message = `סטטוס הגן ${updated.institution.name} עודכן ל-${params.newStatus}`;
  await db_createNotification({
    userId: updated.institution.supervisorId,
    title: "עדכון סטטוס",
    message,
    type: "STATUS_UPDATE",
  });

  return updated;
}

/**
 * לוח שנה
 */
/**
 * שליפת נתונים מורחבת ללוח השנה
 */
export async function db_getCalendarData(month: number, year: number, supervisorId: string) {
  const startDate = new Date(year, month - 1, 1);
  const endDate = new Date(year, month, 0);

  return await prisma.placement.findMany({
    where: {
      date: { gte: startDate, lte: endDate },
      institution: { supervisorId: supervisorId } // סינון לפי המפקחת הרלוונטית
    },
    include: {
      institution: { select: { name: true } },
      mainTeacher: { select: { id: true, firstName: true, lastName: true } },
      substitute: { select: { id: true, firstName: true, lastName: true } },
    },
    orderBy: { date: 'asc' }
  });
}

/**
 * עדכון מהיר של שדה בשיבוץ (עריכה ישירה מהלוח)
 */
export async function db_quickUpdatePlacement(id: string, data: { mainTeacherId?: string, substituteId?: string, status?: any }) {
  return await prisma.placement.update({
    where: { id },
    data,
    include: {
      institution: true,
      substitute: true,
      mainTeacher: true
    }
  });
}
/**
 * אישור שיבוץ
 */
export async function db_assignSubstitute(
  placementId: string,
  substituteId: string
) {
  const updatedPlacement = await prisma.placement.update({
    where: { id: placementId },
    data: { substituteId, status: "ASSIGNED" },
    include: {
      institution: true,
      substitute: { select: { firstName: true, lastName: true } },
      mainTeacher: { select: { firstName: true, lastName: true } },
    },
  });

  const targets = [
    updatedPlacement.institution.supervisorId,
    updatedPlacement.institution.instructorId,
    updatedPlacement.mainTeacherId,
  ];
  for (const userId of targets) {
    await db_createNotification({
      userId,
      title: `שיבוץ נסגר: ${updatedPlacement.institution.name}`,
      message: `נמצאה מחליפה לתאריך ${updatedPlacement.date.toLocaleDateString(
        "he-IL"
      )}`,
      type: "STATUS_UPDATE",
    });
  }

  return updatedPlacement;
}


  [FILE] userService.ts
import { PrismaClient } from '@prisma/client';
import { decrypt, encrypt } from '../utils/crypto';
import bcrypt from 'bcrypt';

const prisma = new PrismaClient();

//  קבלת כל המשתמשים עם פענוח ת"ז
export async function db_getAllUsers() {
  const users = await prisma.user.findMany();
  return users.map(user => ({
    ...user,
    idNumber: user.idNumber ? decrypt(user.idNumber) : null,
    password: "PROTECTED"
  }));
}

//  קבלת משתמש לפי ID
export async function db_getUserById(id: string) {
  const user = await prisma.user.findUnique({ where: { id } });
  if (!user) return null;

  const { password: _, ...userWithoutPassword } = user;
  return {
    ...userWithoutPassword,
    idNumber: user.idNumber ? decrypt(user.idNumber) : null
  };
}

//. קבלת סטטיסטיקות/שיבוצים למשתמש לפי טווח תאריכים
// זה יענה על הצורך של ה-ADMIN לראות מתי גננת החליפה ובאילו גנים
export async function db_getUserStats(userId: string, startDate?: string, endDate?: string) {
  const whereClause: any = {
    OR: [{ mainTeacherId: userId }, { substituteId: userId }]
  };

  if (startDate && endDate) {
    whereClause.date = {
      gte: new Date(startDate),
      lte: new Date(endDate)
    };
  }

  return await prisma.placement.findMany({
    where: whereClause,
    include: { institution: true },
    orderBy: { date: 'asc' }
  });
}

//  קבלת התראות למשתמש
export async function db_getUserNotifications(userId: string) {
  return await prisma.notification.findMany({
    where: { userId },
    orderBy: { createdAt: 'desc' },
    take: 20
  });
}

export async function db_getSubstitutes() {
  return await prisma.user.findMany({
    where: {
      roles: { hasSome: ["SUBSTITUTE", "ROTATION"] },
      isWorking: true
    },
    select: { id: true, firstName: true, lastName: true }
  });
}

[DIR] utils

  [FILE] crypto.ts
import crypto from 'crypto';

const algorithm = 'aes-256-cbc';
const key = Buffer.from(process.env.ENCRYPTION_KEY || '', 'utf8').slice(0, 32);

export const encrypt = (text: string) => {
  const iv = crypto.randomBytes(16); // IV חדש לכל הצפנה
  const cipher = crypto.createCipheriv(algorithm, key, iv);
  let encrypted = cipher.update(text, 'utf8', 'hex');
  encrypted += cipher.final('hex');
  return `${iv.toString('hex')}:${encrypted}`;
};

export const decrypt = (encryptedText: string) => {
  try {
    const [ivHex, encrypted] = encryptedText.split(':');
    if (!ivHex || !encrypted) return encryptedText; // הגנה למקרה שהטקסט לא מוצפן

    const iv = Buffer.from(ivHex, 'hex');
    const decipher = crypto.createDecipheriv(algorithm, key, iv);
    let decrypted = decipher.update(encrypted, 'hex', 'utf8');
    decrypted += decipher.final('utf8');
    return decrypted;
  } catch (error) {
    console.error("Decryption failed:", error);
    return "Error decrypting data";
  }
};

  [FILE] dateHelpers.ts
/**
 * בודק האם ניתן עדיין לבצע שיבוץ לגן שנסגר.
 * המועד האחרון הוא 07:00 בבוקר של יום השיבוץ.
 */
export const isRegistrationOpen = (placementDate: Date | string) => {
  const now = new Date();
  const deadline = new Date(placementDate);
  
  // קביעת המועד ל-07:00 בבוקר של אותו תאריך
  deadline.setHours(7, 0, 0, 0);

  return now < deadline;
};

/**
 * פונקציה אופציונלית לבדיקה אם התאריך הוא היום
 */
export const isToday = (date: Date | string) => {
  const d = new Date(date);
  const today = new Date();
  return d.getDate() === today.getDate() &&
         d.getMonth() === today.getMonth() &&
         d.getFullYear() === today.getFullYear();
};
